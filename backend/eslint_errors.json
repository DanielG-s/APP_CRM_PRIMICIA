[{"filePath":"C:\\Users\\danie\\OneDrive\\Documentos\\CRM-PROJETO\\backend\\src\\app.controller.spec.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\danie\\OneDrive\\Documentos\\CRM-PROJETO\\backend\\src\\app.controller.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\danie\\OneDrive\\Documentos\\CRM-PROJETO\\backend\\src\\app.module.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\danie\\OneDrive\\Documentos\\CRM-PROJETO\\backend\\src\\app.service.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\danie\\OneDrive\\Documentos\\CRM-PROJETO\\backend\\src\\config\\crm.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\danie\\OneDrive\\Documentos\\CRM-PROJETO\\backend\\src\\main.ts","messages":[{"ruleId":"@typescript-eslint/no-floating-promises","severity":1,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":29,"column":1,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":29,"endColumn":13,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[890,890],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[890,890],"text":"await "},"desc":"Add await operator."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NestFactory } from '@nestjs/core';\r\nimport { AppModule } from './app.module';\r\nimport { ValidationPipe } from '@nestjs/common';\r\nimport { DocumentBuilder, SwaggerModule } from '@nestjs/swagger';\r\n\r\nasync function bootstrap() {\r\n  const app = await NestFactory.create(AppModule);\r\n\r\n  app.enableCors();\r\n\r\n  // 1. Ativa a Valida├º├úo Global (para o DTO funcionar e barrar dados errados)\r\n  app.useGlobalPipes(new ValidationPipe());\r\n\r\n  // 2. Configura├º├úo do Swagger (A Documenta├º├úo)\r\n  const config = new DocumentBuilder()\r\n    .setTitle('CRM Merxios API')\r\n    .setDescription('Documenta├º├úo oficial da API do CRM/ERP')\r\n    .setVersion('1.0')\r\n    .build();\r\n\r\n  const document = SwaggerModule.createDocument(app, config);\r\n\r\n  // Essa linha aqui cria a rota /api\r\n  SwaggerModule.setup('api', app, document);\r\n\r\n  // 3. Liga o servidor na porta 3000\r\n  await app.listen(3000);\r\n}\r\nbootstrap();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\danie\\OneDrive\\Documentos\\CRM-PROJETO\\backend\\src\\modules\\config\\settings\\dto\\create-whatsapp.dto.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\danie\\OneDrive\\Documentos\\CRM-PROJETO\\backend\\src\\modules\\config\\settings\\dto\\update-email-settings.dto.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\danie\\OneDrive\\Documentos\\CRM-PROJETO\\backend\\src\\modules\\config\\settings\\settings.controller.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\danie\\OneDrive\\Documentos\\CRM-PROJETO\\backend\\src\\modules\\config\\settings\\settings.module.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\danie\\OneDrive\\Documentos\\CRM-PROJETO\\backend\\src\\modules\\config\\settings\\settings.service.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\danie\\OneDrive\\Documentos\\CRM-PROJETO\\backend\\src\\modules\\crm\\intelligence\\intelligence.controller.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `{ name: string; rules: any; isDynamic: boolean; }`.","line":79,"column":55,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":79,"endColumn":59}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import {\r\n  Controller,\r\n  Get,\r\n  Post,\r\n  Body,\r\n  Patch,\r\n  Delete,\r\n  Param,\r\n  Put,\r\n  Res,\r\n} from '@nestjs/common';\r\nimport { ApiTags, ApiOperation } from '@nestjs/swagger';\r\nimport { IntelligenceService } from './intelligence.service';\r\nimport type { Response } from 'express';\r\n\r\n@ApiTags('Intelig├¬ncia (RFM)')\r\n@Controller('webhook/crm/intelligence') // Mantendo sua rota original\r\nexport class IntelligenceController {\r\n  constructor(private readonly intelligenceService: IntelligenceService) {}\r\n\r\n  /**\r\n   * Returns the RFM analysis (Recency, Frequency, Monetary) for the customer base.\r\n   */\r\n  @Get('rfm')\r\n  @ApiOperation({ summary: 'Retorna a distribui├º├úo da base por RFM' })\r\n  getRFM() {\r\n    return this.intelligenceService.getRfmAnalysis();\r\n  }\r\n\r\n  @Get('segmentation-data')\r\n  async getSegmentationData() {\r\n    return this.intelligenceService.getSegmentationData();\r\n  }\r\n\r\n  /**\r\n   * Retrieves available options for filtering segments (Cities, States, Products, etc.).\r\n   */\r\n  @Get('filters')\r\n  async getFilterOptions() {\r\n    return this.intelligenceService.getFilterOptions();\r\n  }\r\n\r\n  // --- MUDAN├çA PRINCIPAL AQUI ---\r\n  /**\r\n   * Lists all segments with their trend analysis (growth/shrinkage compared to last snapshot).\r\n   */\r\n  @Get('segments')\r\n  @ApiOperation({ summary: 'Lista segmentos com dados de tend├¬ncia e alcance' })\r\n  async listSegments() {\r\n    // Agora chama o m├®todo que calcula evolu├º├úo vs ontem\r\n    return this.intelligenceService.findAllSegmentsWithTrend();\r\n  }\r\n\r\n  // --- NOVO ENDPOINT DE TESTE ---\r\n  @Post('segments/snapshot')\r\n  @ApiOperation({\r\n    summary:\r\n      'For├ºa o snapshot di├írio manualmente (Para testar hist├│rico agora)',\r\n  })\r\n  async forceSnapshot() {\r\n    await this.intelligenceService.handleDailySegmentSnapshot();\r\n    return {\r\n      message:\r\n        'Snapshot di├írio executado com sucesso. Verifique a tabela SegmentHistory.',\r\n    };\r\n  }\r\n\r\n  @Get('segments/:id')\r\n  async getSegment(@Param('id') id: string) {\r\n    return this.intelligenceService.getSegmentById(id);\r\n  }\r\n\r\n  @Put('segments/:id')\r\n  async updateSegment(@Param('id') id: string, @Body() body: any) {\r\n    // --- ATEN├ç├âO: MOCK DE USU├üRIO ---\r\n    // Em produ├º├úo, pegue isso do req.user.id (via AuthGuard)\r\n    const mockUserId = undefined;\r\n\r\n    return this.intelligenceService.updateSegment(id, body, mockUserId);\r\n  }\r\n\r\n  @Patch('segments/:id/status')\r\n  async toggleStatus(@Param('id') id: string) {\r\n    return this.intelligenceService.toggleSegmentStatus(id);\r\n  }\r\n\r\n  @Delete('segments/:id')\r\n  async deleteSegment(@Param('id') id: string) {\r\n    return this.intelligenceService.deleteSegment(id);\r\n  }\r\n\r\n  /**\r\n   * Creates a new customer segment.\r\n   * @param body.name Name of the segment.\r\n   * @param body.rules Array of rules.\r\n   * @param body.isDynamic Whether it updates automatically.\r\n   */\r\n  @Post('segments')\r\n  async createSegment(\r\n    @Body() body: { name: string; rules: any; isDynamic: boolean },\r\n  ) {\r\n    return this.intelligenceService.createSegment(body);\r\n  }\r\n\r\n  /**\r\n   * Previews the result of a segmentation rule without saving it.\r\n   */\r\n  @Post('preview')\r\n  async previewSegment(@Body() body: { rules: any[] }) {\r\n    return this.intelligenceService.calculatePreview(body.rules);\r\n  }\r\n\r\n  // --- ROTA DE DOWNLOAD ---\r\n  /**\r\n   * Exports a segment's customer list to CSV.\r\n   */\r\n  @Get('segments/:id/export')\r\n  async exportCsv(@Param('id') id: string, @Res() res: Response) {\r\n    const csvContent = await this.intelligenceService.exportSegmentToCsv(id);\r\n\r\n    // Define o nome do arquivo\r\n    const fileName = `export_segment_${id.substring(0, 8)}.csv`;\r\n\r\n    // Headers para for├ºar download\r\n    res.header('Content-Type', 'text/csv');\r\n    res.attachment(fileName);\r\n\r\n    // Envia o conte├║do\r\n    return res.send(csvContent);\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\danie\\OneDrive\\Documentos\\CRM-PROJETO\\backend\\src\\modules\\crm\\intelligence\\intelligence.module.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\danie\\OneDrive\\Documentos\\CRM-PROJETO\\backend\\src\\modules\\crm\\intelligence\\intelligence.service.spec.ts","messages":[{"ruleId":"@typescript-eslint/unbound-method","severity":2,"message":"A method that is not declared with `this: void` may cause unintentional scoping of `this` when separated from its object.\nConsider using an arrow function or explicitly `.bind()`ing the method to avoid calling the method with an unintended `this` value. \nIf a function does not access `this`, it can be annotated with `this: void`.","line":97,"column":14,"nodeType":"MemberExpression","messageId":"unboundWithoutThisAnnotation","endLine":97,"endColumn":42},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":98,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":98,"endColumn":73},{"ruleId":"@typescript-eslint/unbound-method","severity":2,"message":"A method that is not declared with `this: void` may cause unintentional scoping of `this` when separated from its object.\nConsider using an arrow function or explicitly `.bind()`ing the method to avoid calling the method with an unintended `this` value. \nIf a function does not access `this`, it can be annotated with `this: void`.","line":101,"column":14,"nodeType":"MemberExpression","messageId":"unboundWithoutThisAnnotation","endLine":101,"endColumn":35},{"ruleId":"@typescript-eslint/unbound-method","severity":2,"message":"A method that is not declared with `this: void` may cause unintentional scoping of `this` when separated from its object.\nConsider using an arrow function or explicitly `.bind()`ing the method to avoid calling the method with an unintended `this` value. \nIf a function does not access `this`, it can be annotated with `this: void`.","line":121,"column":14,"nodeType":"MemberExpression","messageId":"unboundWithoutThisAnnotation","endLine":121,"endColumn":35},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":123,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":123,"endColumn":78}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Test, TestingModule } from '@nestjs/testing';\r\nimport { IntelligenceService } from './intelligence.service';\r\nimport { PrismaService } from 'src/prisma/prisma.service';\r\nimport { SegmentationQueryBuilder } from './services/segmentation-query.builder';\r\nimport { RfmAnalysisService } from './services/rfm-analysis.service';\r\nimport { DataExportService } from './services/data-export.service';\r\n\r\ndescribe('IntelligenceService', () => {\r\n  let service: IntelligenceService;\r\n  let prisma: PrismaService;\r\n\r\n  const mockPrisma = {\r\n    customer: {\r\n      count: jest.fn(),\r\n      findMany: jest.fn(),\r\n      aggregate: jest.fn(),\r\n    },\r\n    segment: {\r\n      findMany: jest.fn(),\r\n      findFirst: jest.fn(),\r\n      create: jest.fn(),\r\n      update: jest.fn(),\r\n    },\r\n    segmentHistory: {\r\n      create: jest.fn(),\r\n    },\r\n    store: {\r\n      findFirst: jest.fn(),\r\n    },\r\n  };\r\n\r\n  const mockQueryBuilder = {\r\n    build: jest.fn().mockReturnValue({}),\r\n  };\r\n\r\n  const mockRfmService = {\r\n    getAnalysis: jest.fn().mockResolvedValue([]),\r\n    updateCustomerMetrics: jest.fn(),\r\n  };\r\n\r\n  const mockExportService = {\r\n    exportSegmentToCsv: jest.fn(),\r\n  };\r\n\r\n  beforeEach(async () => {\r\n    const module: TestingModule = await Test.createTestingModule({\r\n      providers: [\r\n        IntelligenceService,\r\n        { provide: PrismaService, useValue: mockPrisma },\r\n        { provide: SegmentationQueryBuilder, useValue: mockQueryBuilder },\r\n        { provide: RfmAnalysisService, useValue: mockRfmService },\r\n        { provide: DataExportService, useValue: mockExportService },\r\n      ],\r\n    }).compile();\r\n\r\n    service = module.get<IntelligenceService>(IntelligenceService);\r\n    prisma = module.get<PrismaService>(PrismaService);\r\n  });\r\n\r\n  afterEach(() => {\r\n    jest.clearAllMocks();\r\n  });\r\n\r\n  describe('calculatePreview', () => {\r\n    it('should return aggregated metrics', async () => {\r\n      mockPrisma.customer.count.mockResolvedValueOnce(50); // Filtered\r\n      mockPrisma.customer.count.mockResolvedValueOnce(100); // Total\r\n\r\n      mockPrisma.customer.aggregate.mockResolvedValueOnce({\r\n        _sum: { totalSpent: 5000 },\r\n        _count: { id: 20 },\r\n      });\r\n      mockPrisma.customer.aggregate.mockResolvedValueOnce({\r\n        _count: { email: 40, phone: 30 },\r\n      });\r\n\r\n      mockPrisma.customer.findMany.mockResolvedValue([]);\r\n\r\n      const result = await service.calculatePreview([]);\r\n\r\n      expect(result.metrics.total).toBe(50);\r\n      expect(result.metrics.percent).toBe('50.0');\r\n      expect(result.metrics.revenue.total).toBe(5000);\r\n      expect(result.metrics.channels.email).toBe(40);\r\n    });\r\n  });\r\n\r\n  describe('handleDailySegmentSnapshot', () => {\r\n    it('should process snapshots for active segments', async () => {\r\n      mockPrisma.segment.findMany.mockResolvedValue([\r\n        { id: 'seg1', rules: [], name: 'Active Segment' },\r\n      ]);\r\n      mockPrisma.customer.count.mockResolvedValue(123);\r\n\r\n      await service.handleDailySegmentSnapshot();\r\n\r\n      expect(prisma.segmentHistory.create).toHaveBeenCalledWith({\r\n        data: expect.objectContaining({ segmentId: 'seg1', count: 123 }),\r\n      });\r\n\r\n      expect(prisma.segment.update).toHaveBeenCalledWith({\r\n        where: { id: 'seg1' },\r\n        data: { lastCount: 123 },\r\n      });\r\n    });\r\n  });\r\n\r\n  describe('createSegment', () => {\r\n    it('should create a new segment and calculate initial size', async () => {\r\n      mockPrisma.store.findFirst.mockResolvedValue({ id: 'store1' });\r\n      mockPrisma.segment.findFirst.mockResolvedValue(null);\r\n      mockPrisma.customer.count.mockResolvedValue(10);\r\n      mockPrisma.segment.create.mockResolvedValue({ id: 'new-seg' });\r\n\r\n      await service.createSegment({\r\n        name: 'New Segment',\r\n        rules: [],\r\n        isDynamic: true,\r\n      });\r\n\r\n      expect(prisma.segment.create).toHaveBeenCalledWith(\r\n        expect.objectContaining({\r\n          data: expect.objectContaining({ lastCount: 10, storeId: 'store1' }),\r\n        }),\r\n      );\r\n    });\r\n  });\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\danie\\OneDrive\\Documentos\\CRM-PROJETO\\backend\\src\\modules\\crm\\intelligence\\intelligence.service.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Prisma' is defined but never used.","line":3,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":16},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `any[]`.","line":214,"column":49,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":214,"endColumn":59},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":220,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":220,"endColumn":26},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `any[]`.","line":244,"column":49,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":244,"endColumn":59},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":251,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":251,"endColumn":26},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .name on an `any` value.","line":299,"column":18,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":299,"endColumn":22},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":299,"column":40,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":299,"endColumn":49},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .name on an `any` value.","line":299,"column":45,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":299,"endColumn":49},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .category on an `any` value.","line":300,"column":18,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":300,"endColumn":26},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":300,"column":46,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":300,"endColumn":59},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .category on an `any` value.","line":300,"column":51,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":300,"endColumn":59},{"ruleId":"@typescript-eslint/require-await","severity":2,"message":"Async method 'getSegmentationData' has no 'await' expression.","line":320,"column":3,"nodeType":"FunctionExpression","messageId":"missingAwait","endLine":320,"endColumn":28,"suggestions":[{"messageId":"removeAsync","fix":{"range":[10034,10040],"text":""},"desc":"Remove 'async'."}]}],"suppressedMessages":[],"errorCount":8,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Injectable, ConflictException } from '@nestjs/common';\r\nimport { PrismaService } from 'src/prisma/prisma.service';\r\nimport { Prisma } from '@prisma/client';\r\nimport { Cron, CronExpression } from '@nestjs/schedule';\r\nimport { SegmentationQueryBuilder } from './services/segmentation-query.builder';\r\nimport { RfmAnalysisService } from './services/rfm-analysis.service';\r\nimport { DataExportService } from './services/data-export.service';\r\n\r\n@Injectable()\r\nexport class IntelligenceService {\r\n  constructor(\r\n    private prisma: PrismaService,\r\n    private queryBuilder: SegmentationQueryBuilder,\r\n    private rfmService: RfmAnalysisService,\r\n    private exportService: DataExportService,\r\n  ) {}\r\n\r\n  // ===========================================================================\r\n  // 1. DASHBOARD RFM\r\n  // ===========================================================================\r\n  /**\r\n   * Retrieves the current RFM analysis.\r\n   * Delegates to RfmAnalysisService.\r\n   * @returns {Promise<any>} The RFM analysis data.\r\n   */\r\n  async getRfmAnalysis() {\r\n    return this.rfmService.getAnalysis();\r\n  }\r\n\r\n  // ===========================================================================\r\n  // 2. ENGINE DE C├üLCULO REAL\r\n  // ===========================================================================\r\n  /**\r\n   * Calculates a preview of customer metrics based on segmentation rules.\r\n   * Returns total count, revenue stats, and a list of sample clients.\r\n   *\r\n   * @param rules Array of segmentation rules (e.g., filters by state, city, spend).\r\n   * @returns {Promise<{metrics: any, matchedClients: any[]}>} Preview data.\r\n   */\r\n  async calculatePreview(rules: any[]) {\r\n    const whereClause = this.queryBuilder.build(rules);\r\n\r\n    const totalClients = await this.prisma.customer.count({\r\n      where: whereClause,\r\n    });\r\n    const totalDatabase = await this.prisma.customer.count();\r\n\r\n    const matchedClients = await this.prisma.customer.findMany({\r\n      where: whereClause,\r\n      take: 10,\r\n      select: {\r\n        id: true,\r\n        name: true,\r\n        email: true,\r\n        city: true,\r\n        state: true,\r\n        rfmStatus: true,\r\n      },\r\n    });\r\n\r\n    const aggregates = await this.prisma.customer.aggregate({\r\n      where: whereClause,\r\n      _sum: { totalSpent: true },\r\n      _count: { id: true },\r\n    });\r\n\r\n    const channelCounts = await this.prisma.customer.aggregate({\r\n      where: whereClause,\r\n      _count: {\r\n        email: true,\r\n        phone: true,\r\n      },\r\n    });\r\n\r\n    return {\r\n      metrics: {\r\n        total: totalClients,\r\n        percent:\r\n          totalDatabase > 0\r\n            ? ((totalClients / totalDatabase) * 100).toFixed(1)\r\n            : 0,\r\n        revenue: {\r\n          total: Number(aggregates._sum.totalSpent || 0),\r\n          buyers: aggregates._count.id,\r\n          orders_count: 0,\r\n        },\r\n        channels: {\r\n          email: channelCounts._count.email || 0,\r\n          whatsapp: channelCounts._count.phone || 0,\r\n        },\r\n      },\r\n      matchedClients: matchedClients.map((c) => ({\r\n        ...c,\r\n        rfm: c.rfmStatus || 'Novos / Sem Dados',\r\n      })),\r\n    };\r\n  }\r\n\r\n  // ===========================================================================\r\n  // 3. MANUTEN├ç├âO AUTOM├üTICA (CRON JOB)\r\n  // ===========================================================================\r\n\r\n  /**\r\n   * CRON JOB: Runs everyday at 3 AM.\r\n   * Takes a snapshot of customer counts for all active segments.\r\n   * Stores history in SegmentHistory table and updates lastCount.\r\n   */\r\n  @Cron(CronExpression.EVERY_DAY_AT_3AM)\r\n  async handleDailySegmentSnapshot() {\r\n    console.log('­ƒô© Iniciando snapshot di├írio dos segmentos...');\r\n\r\n    const segments = await this.prisma.segment.findMany({\r\n      where: { active: true },\r\n    });\r\n\r\n    for (const seg of segments) {\r\n      try {\r\n        const whereClause = this.queryBuilder.build(seg.rules as any[]);\r\n        const currentCount = await this.prisma.customer.count({\r\n          where: whereClause,\r\n        });\r\n\r\n        await this.prisma.segmentHistory.create({\r\n          data: {\r\n            segmentId: seg.id,\r\n            count: currentCount,\r\n            date: new Date(),\r\n          },\r\n        });\r\n\r\n        await this.prisma.segment.update({\r\n          where: { id: seg.id },\r\n          data: { lastCount: currentCount },\r\n        });\r\n      } catch (error) {\r\n        console.error(\r\n          `Erro ao processar snapshot do segmento ${seg.name}:`,\r\n          error,\r\n        );\r\n      }\r\n    }\r\n    console.log('Ô£à Snapshot di├írio conclu├¡do.');\r\n  }\r\n\r\n  // M├®todo unificado para listagem com tend├¬ncia\r\n  /**\r\n   * Lists all segments with their trend analysis (growth/shrinkage compared to last snapshot).\r\n   * @returns {Promise<{segments: any[], totalCustomers: number}>} List of segments with metrics.\r\n   */\r\n  async findAllSegmentsWithTrend() {\r\n    const totalCustomers = await this.prisma.customer.count();\r\n\r\n    const segments = await this.prisma.segment.findMany({\r\n      orderBy: { updatedAt: 'desc' },\r\n      include: {\r\n        updatedBy: { select: { name: true, email: true } },\r\n        history: {\r\n          orderBy: { date: 'desc' },\r\n          take: 1,\r\n          skip: 1,\r\n        },\r\n      },\r\n    });\r\n\r\n    const formattedSegments = segments.map((seg) => {\r\n      const currentCount = seg.lastCount;\r\n      const previousCount = seg.history[0]?.count || currentCount;\r\n\r\n      let trendPercent = 0;\r\n      if (previousCount > 0) {\r\n        trendPercent = ((currentCount - previousCount) / previousCount) * 100;\r\n      }\r\n\r\n      return {\r\n        ...seg,\r\n        metrics: {\r\n          totalBase: totalCustomers,\r\n          reachPercent:\r\n            totalCustomers > 0\r\n              ? ((currentCount / totalCustomers) * 100).toFixed(1)\r\n              : 0,\r\n          trend: trendPercent.toFixed(1),\r\n        },\r\n      };\r\n    });\r\n\r\n    return { segments: formattedSegments, totalCustomers };\r\n  }\r\n\r\n  // ===========================================================================\r\n  // 4. CRUD\r\n  // ===========================================================================\r\n\r\n  /**\r\n   * Creates a new Customer Segment.\r\n   *\r\n   * @param data.name Name of the segment.\r\n   * @param data.rules Rules definition (JSON).\r\n   * @param data.isDynamic Whether the segment updates automatically.\r\n   * @throws {ConflictException} If a segment with the same name already exists.\r\n   */\r\n  async createSegment(data: { name: string; rules: any; isDynamic: boolean }) {\r\n    const store = await this.prisma.store.findFirst();\r\n    const existingSegment = await this.prisma.segment.findFirst({\r\n      where: {\r\n        name: { equals: data.name, mode: 'insensitive' },\r\n        storeId: store?.id,\r\n      },\r\n    });\r\n\r\n    if (existingSegment)\r\n      throw new ConflictException('J├í existe um segmento com este nome.');\r\n\r\n    const whereClause = this.queryBuilder.build(data.rules);\r\n    const count = await this.prisma.customer.count({ where: whereClause });\r\n\r\n    return this.prisma.segment.create({\r\n      data: {\r\n        name: data.name,\r\n        rules: data.rules,\r\n        logic: 'custom',\r\n        active: true,\r\n        storeId: store?.id || 'default',\r\n        isDynamic: data.isDynamic,\r\n        lastCount: count,\r\n      },\r\n    });\r\n  }\r\n\r\n  async updateSegment(\r\n    id: string,\r\n    data: { name: string; rules: any; isDynamic: boolean },\r\n    userId?: string,\r\n  ) {\r\n    const existing = await this.prisma.segment.findFirst({\r\n      where: {\r\n        name: { equals: data.name, mode: 'insensitive' },\r\n        id: { not: id },\r\n      },\r\n    });\r\n    if (existing)\r\n      throw new ConflictException('J├í existe outro segmento com este nome.');\r\n\r\n    const whereClause = this.queryBuilder.build(data.rules);\r\n    const count = await this.prisma.customer.count({ where: whereClause });\r\n\r\n    return this.prisma.segment.update({\r\n      where: { id },\r\n      data: {\r\n        name: data.name,\r\n        rules: data.rules,\r\n        isDynamic: data.isDynamic,\r\n        updatedById: userId,\r\n        lastCount: count,\r\n      },\r\n    });\r\n  }\r\n\r\n  // ===========================================================================\r\n  // 5. M├ëTODOS AUXILIARES\r\n  // ===========================================================================\r\n\r\n  /**\r\n   * Retrieves available options for filtering (Cities, States, Products, etc.).\r\n   * Used to populate UI select inputs.\r\n   */\r\n  async getFilterOptions() {\r\n    const citiesRaw = await this.prisma.customer.findMany({\r\n      where: { city: { not: null } },\r\n      select: { city: true },\r\n      distinct: ['city'],\r\n      orderBy: { city: 'asc' },\r\n    });\r\n    const statesRaw = await this.prisma.customer.findMany({\r\n      where: { state: { not: null } },\r\n      select: { state: true },\r\n      distinct: ['state'],\r\n      orderBy: { state: 'asc' },\r\n    });\r\n\r\n    const segmentsRaw = await this.prisma.segment.findMany({\r\n      where: { active: true },\r\n      select: { id: true, name: true },\r\n      orderBy: { name: 'asc' },\r\n    });\r\n\r\n    const recentTransactions = await this.prisma.transaction.findMany({\r\n      take: 1000,\r\n      orderBy: { date: 'desc' },\r\n      select: { items: true },\r\n    });\r\n\r\n    const categoriesSet = new Set<string>();\r\n    const productsSet = new Set<string>();\r\n\r\n    recentTransactions.forEach((t) => {\r\n      const items = (t.items as any[]) || [];\r\n      items.forEach((item) => {\r\n        if (item.name) productsSet.add(item.name);\r\n        if (item.category) categoriesSet.add(item.category);\r\n      });\r\n    });\r\n\r\n    return {\r\n      cities: citiesRaw.map((c) => c.city).filter(Boolean),\r\n      states: statesRaw.map((s) => s.state).filter(Boolean),\r\n      segments: segmentsRaw,\r\n      products: Array.from(productsSet).sort(),\r\n      categories: Array.from(categoriesSet).sort(),\r\n      campaigns: [],\r\n      departments: [],\r\n      search_terms: [],\r\n    };\r\n  }\r\n\r\n  async findAllSegments() {\r\n    return this.findAllSegmentsWithTrend();\r\n  }\r\n\r\n  async getSegmentationData() {\r\n    return { clients: [], events: [], orders: [] };\r\n  }\r\n\r\n  async getSegmentById(id: string) {\r\n    const segment = await this.prisma.segment.findUnique({ where: { id } });\r\n    if (!segment) throw new Error('Segmento n├úo encontrado');\r\n    return segment;\r\n  }\r\n\r\n  async toggleSegmentStatus(id: string) {\r\n    const s = await this.prisma.segment.findUnique({ where: { id } });\r\n    if (!s) throw new Error('Segmento n├úo encontrado');\r\n    return this.prisma.segment.update({\r\n      where: { id },\r\n      data: { active: !s.active },\r\n    });\r\n  }\r\n\r\n  async deleteSegment(id: string) {\r\n    return this.prisma.segment.delete({ where: { id } });\r\n  }\r\n\r\n  async updateCustomerMetrics(customerId: string) {\r\n    return this.rfmService.updateCustomerMetrics(customerId);\r\n  }\r\n\r\n  // Legacy method removed/merged into handleDailySegmentSnapshot\r\n  // async handleDailyUpdate() { ... }\r\n\r\n  async exportSegmentToCsv(segmentId: string): Promise<string> {\r\n    return this.exportService.exportSegmentToCsv(segmentId);\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\danie\\OneDrive\\Documentos\\CRM-PROJETO\\backend\\src\\modules\\crm\\intelligence\\services\\data-export.service.ts","messages":[{"ruleId":"@typescript-eslint/restrict-template-expressions","severity":2,"message":"Invalid type \"Decimal\" of template literal expression.","line":47,"column":94,"nodeType":"LogicalExpression","messageId":"invalidType","endLine":47,"endColumn":111}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Injectable } from '@nestjs/common';\r\nimport { PrismaService } from 'src/prisma/prisma.service';\r\nimport { SegmentationQueryBuilder } from './segmentation-query.builder';\r\nimport { CRM_CONFIG } from 'src/config/crm.config';\r\n\r\n@Injectable()\r\nexport class DataExportService {\r\n  constructor(\r\n    private prisma: PrismaService,\r\n    private queryBuilder: SegmentationQueryBuilder,\r\n  ) {}\r\n\r\n  async exportSegmentToCsv(segmentId: string): Promise<string> {\r\n    const segment = await this.prisma.segment.findUnique({\r\n      where: { id: segmentId },\r\n    });\r\n\r\n    if (!segment) throw new Error('Segmento n├úo encontrado');\r\n\r\n    const whereClause = this.queryBuilder.build(segment.rules as any[]);\r\n\r\n    const customers = await this.prisma.customer.findMany({\r\n      where: whereClause,\r\n      take: CRM_CONFIG.SEGMENTATION.EXPORT_LIMIT,\r\n      orderBy: { name: 'asc' },\r\n      select: {\r\n        name: true,\r\n        email: true,\r\n        phone: true,\r\n        city: true,\r\n        state: true,\r\n        totalSpent: true,\r\n        lastOrderDate: true,\r\n      },\r\n    });\r\n\r\n    const header = 'Nome,Email,Telefone,Cidade,UF,Total Gasto,Ultima Compra\\n';\r\n\r\n    const rows = customers\r\n      .map((c) => {\r\n        const safeName = c.name ? `\"${c.name.replace(/\"/g, '\"\"')}\"` : '';\r\n        const safeCity = c.city ? `\"${c.city}\"` : '';\r\n        const date = c.lastOrderDate\r\n          ? c.lastOrderDate.toISOString().split('T')[0]\r\n          : '';\r\n\r\n        return `${safeName},${c.email || ''},${c.phone || ''},${safeCity},${c.state || ''},${c.totalSpent || 0},${date}`;\r\n      })\r\n      .join('\\n');\r\n\r\n    return header + rows;\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\danie\\OneDrive\\Documentos\\CRM-PROJETO\\backend\\src\\modules\\crm\\intelligence\\services\\rfm-analysis.service.spec.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'CRM_CONFIG' is defined but never used.","line":4,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":20},{"ruleId":"@typescript-eslint/unbound-method","severity":2,"message":"A method that is not declared with `this: void` may cause unintentional scoping of `this` when separated from its object.\nConsider using an arrow function or explicitly `.bind()`ing the method to avoid calling the method with an unintended `this` value. \nIf a function does not access `this`, it can be annotated with `this: void`.","line":63,"column":14,"nodeType":"MemberExpression","messageId":"unboundWithoutThisAnnotation","endLine":63,"endColumn":36},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":65,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":65,"endColumn":69},{"ruleId":"@typescript-eslint/unbound-method","severity":2,"message":"A method that is not declared with `this: void` may cause unintentional scoping of `this` when separated from its object.\nConsider using an arrow function or explicitly `.bind()`ing the method to avoid calling the method with an unintended `this` value. \nIf a function does not access `this`, it can be annotated with `this: void`.","line":81,"column":14,"nodeType":"MemberExpression","messageId":"unboundWithoutThisAnnotation","endLine":81,"endColumn":36},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":83,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":83,"endColumn":68},{"ruleId":"@typescript-eslint/unbound-method","severity":2,"message":"A method that is not declared with `this: void` may cause unintentional scoping of `this` when separated from its object.\nConsider using an arrow function or explicitly `.bind()`ing the method to avoid calling the method with an unintended `this` value. \nIf a function does not access `this`, it can be annotated with `this: void`.","line":99,"column":14,"nodeType":"MemberExpression","messageId":"unboundWithoutThisAnnotation","endLine":99,"endColumn":36},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":101,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":101,"endColumn":64}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Test, TestingModule } from '@nestjs/testing';\r\nimport { RfmAnalysisService } from './rfm-analysis.service';\r\nimport { PrismaService } from 'src/prisma/prisma.service';\r\nimport { CRM_CONFIG } from 'src/config/crm.config';\r\n\r\n// Mock do CRM Config para testes previs├¡veis\r\njest.mock('src/config/crm.config', () => ({\r\n  CRM_CONFIG: {\r\n    RFM: {\r\n      CHURN_DAYS: 180,\r\n      RISK_DAYS: 90,\r\n      LOYAL_ORDER_COUNT: 5,\r\n      LOYAL_TOTAL_SPENT: 1000,\r\n      MIN_ORDERS_FOR_LOYALTY: 1,\r\n    },\r\n  },\r\n}));\r\n\r\ndescribe('RfmAnalysisService', () => {\r\n  let service: RfmAnalysisService;\r\n  let prisma: PrismaService;\r\n\r\n  const mockPrisma = {\r\n    customer: {\r\n      groupBy: jest.fn(),\r\n      update: jest.fn(),\r\n    },\r\n    transaction: {\r\n      aggregate: jest.fn(),\r\n    },\r\n  };\r\n\r\n  beforeEach(async () => {\r\n    const module: TestingModule = await Test.createTestingModule({\r\n      providers: [\r\n        RfmAnalysisService,\r\n        { provide: PrismaService, useValue: mockPrisma },\r\n      ],\r\n    }).compile();\r\n\r\n    service = module.get<RfmAnalysisService>(RfmAnalysisService);\r\n    prisma = module.get<PrismaService>(PrismaService);\r\n  });\r\n\r\n  afterEach(() => {\r\n    jest.clearAllMocks();\r\n  });\r\n\r\n  describe('updateCustomerMetrics', () => {\r\n    it('should classify as Hibernando if churn days exceeded', async () => {\r\n      // Data antiga (> 180 dias)\r\n      const oldDate = new Date();\r\n      oldDate.setDate(oldDate.getDate() - 200);\r\n\r\n      mockPrisma.transaction.aggregate.mockResolvedValue({\r\n        _sum: { totalValue: 50 },\r\n        _count: { id: 10 },\r\n        _max: { date: oldDate },\r\n      });\r\n\r\n      await service.updateCustomerMetrics('cust1');\r\n\r\n      expect(prisma.customer.update).toHaveBeenCalledWith(\r\n        expect.objectContaining({\r\n          data: expect.objectContaining({ rfmStatus: 'Hibernando' }),\r\n        }),\r\n      );\r\n    });\r\n\r\n    it('should classify as Champions if spent > 1000', async () => {\r\n      const recentDate = new Date();\r\n\r\n      mockPrisma.transaction.aggregate.mockResolvedValue({\r\n        _sum: { totalValue: 1500 },\r\n        _count: { id: 3 },\r\n        _max: { date: recentDate },\r\n      });\r\n\r\n      await service.updateCustomerMetrics('cust2');\r\n\r\n      expect(prisma.customer.update).toHaveBeenCalledWith(\r\n        expect.objectContaining({\r\n          data: expect.objectContaining({ rfmStatus: 'Champions' }),\r\n        }),\r\n      );\r\n    });\r\n\r\n    it('should classify as Leais if orders > 1 but not champion', async () => {\r\n      const recentDate = new Date();\r\n\r\n      mockPrisma.transaction.aggregate.mockResolvedValue({\r\n        _sum: { totalValue: 100 },\r\n        _count: { id: 3 },\r\n        _max: { date: recentDate },\r\n      });\r\n\r\n      await service.updateCustomerMetrics('cust3');\r\n\r\n      expect(prisma.customer.update).toHaveBeenCalledWith(\r\n        expect.objectContaining({\r\n          data: expect.objectContaining({ rfmStatus: 'Leais' }),\r\n        }),\r\n      );\r\n    });\r\n  });\r\n\r\n  describe('getAnalysis', () => {\r\n    it('should aggregate RFM groups correctly', async () => {\r\n      mockPrisma.customer.groupBy.mockResolvedValue([\r\n        { rfmStatus: 'Champions', _count: { id: 10 } },\r\n        { rfmStatus: 'Hibernando', _count: { id: 5 } },\r\n      ]);\r\n\r\n      const result = await service.getAnalysis();\r\n\r\n      expect(result.find((r) => r.name === 'Champions')?.value).toBe(10);\r\n      expect(result.find((r) => r.name === 'Hibernando')?.value).toBe(5);\r\n      expect(result.find((r) => r.name === 'Leais')?.value).toBe(0); // Default 0\r\n    });\r\n  });\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\danie\\OneDrive\\Documentos\\CRM-PROJETO\\backend\\src\\modules\\crm\\intelligence\\services\\rfm-analysis.service.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .value on an `error` typed value.","line":36,"column":27,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":36,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .id on an `any` value.","line":36,"column":54,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":36,"endColumn":56},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an error typed value.","line":42,"column":7,"nodeType":"Property","messageId":"anyAssignment","endLine":42,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .value on an `error` typed value.","line":42,"column":27,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":42,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an error typed value.","line":43,"column":7,"nodeType":"Property","messageId":"anyAssignment","endLine":43,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .color on an `error` typed value.","line":43,"column":27,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":43,"endColumn":32}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Injectable } from '@nestjs/common';\r\nimport { PrismaService } from 'src/prisma/prisma.service';\r\nimport { CRM_CONFIG } from 'src/config/crm.config';\r\nimport { Prisma } from '@prisma/client';\r\n\r\n@Injectable()\r\nexport class RfmAnalysisService {\r\n  constructor(private prisma: PrismaService) {}\r\n\r\n  async getAnalysis() {\r\n    const groups = await this.prisma.customer.groupBy({\r\n      by: ['rfmStatus'],\r\n      _count: { id: true },\r\n    });\r\n\r\n    const resultMap = {\r\n      Champions: { value: 0, color: '#10b981' },\r\n      Leais: { value: 0, color: '#3b82f6' },\r\n      Recentes: { value: 0, color: '#6366f1' },\r\n      'Em Risco': { value: 0, color: '#f59e0b' },\r\n      Hibernando: { value: 0, color: '#ef4444' },\r\n      'Novos / Sem Dados': { value: 0, color: '#9ca3af' },\r\n    };\r\n\r\n    groups.forEach((g) => {\r\n      const key = g.rfmStatus || 'Novos / Sem Dados';\r\n      let mapKey = key;\r\n\r\n      if (key.includes('Champions')) mapKey = 'Champions';\r\n      if (key.includes('Leais')) mapKey = 'Leais';\r\n      if (key.includes('Recentes')) mapKey = 'Recentes';\r\n      if (key.includes('Risco')) mapKey = 'Em Risco';\r\n      if (key.includes('Hibernando')) mapKey = 'Hibernando';\r\n\r\n      if (resultMap[mapKey] && g._count) {\r\n        resultMap[mapKey].value += (g._count as any).id || 0;\r\n      }\r\n    });\r\n\r\n    return Object.keys(resultMap).map((k) => ({\r\n      name: k,\r\n      value: resultMap[k].value,\r\n      color: resultMap[k].color,\r\n    }));\r\n  }\r\n\r\n  async updateCustomerMetrics(customerId: string) {\r\n    const aggregates = await this.prisma.transaction.aggregate({\r\n      where: { customerId },\r\n      _sum: { totalValue: true },\r\n      _count: { id: true },\r\n      _max: { date: true },\r\n    });\r\n\r\n    const totalSpent = Number(aggregates._sum.totalValue || 0);\r\n    const ordersCount = aggregates._count.id || 0;\r\n    const lastOrderDate = aggregates._max.date;\r\n\r\n    let rfmStatus = 'Novos / Sem Dados';\r\n\r\n    if (ordersCount > 0 && lastOrderDate) {\r\n      const daysSince = Math.floor(\r\n        (new Date().getTime() - lastOrderDate.getTime()) / (1000 * 3600 * 24),\r\n      );\r\n\r\n      if (daysSince > CRM_CONFIG.RFM.CHURN_DAYS) rfmStatus = 'Hibernando';\r\n      else if (daysSince > CRM_CONFIG.RFM.RISK_DAYS) rfmStatus = 'Em Risco';\r\n      else if (\r\n        totalSpent > CRM_CONFIG.RFM.LOYAL_TOTAL_SPENT ||\r\n        ordersCount > CRM_CONFIG.RFM.LOYAL_ORDER_COUNT\r\n      )\r\n        rfmStatus = 'Champions';\r\n      else if (ordersCount > CRM_CONFIG.RFM.MIN_ORDERS_FOR_LOYALTY)\r\n        rfmStatus = 'Leais';\r\n      else rfmStatus = 'Recentes';\r\n    }\r\n\r\n    await this.prisma.customer.update({\r\n      where: { id: customerId },\r\n      data: {\r\n        totalSpent: new Prisma.Decimal(totalSpent),\r\n        ordersCount,\r\n        lastOrderDate,\r\n        rfmStatus,\r\n      },\r\n    });\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\danie\\OneDrive\\Documentos\\CRM-PROJETO\\backend\\src\\modules\\crm\\intelligence\\services\\segmentation-query.builder.spec.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\danie\\OneDrive\\Documentos\\CRM-PROJETO\\backend\\src\\modules\\crm\\intelligence\\services\\segmentation-query.builder.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .field on an `any` value.","line":12,"column":16,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":12,"endColumn":21},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .operator on an `any` value.","line":13,"column":16,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":13,"endColumn":24},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .category on an `any` value.","line":14,"column":17,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":14,"endColumn":25},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .category on an `any` value.","line":25,"column":17,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":25,"endColumn":25},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .category on an `any` value.","line":27,"column":24,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":27,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":29,"column":24,"nodeType":"Property","messageId":"anyAssignment","endLine":29,"endColumn":46},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .status on an `any` value.","line":29,"column":40,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":29,"endColumn":46},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .category on an `any` value.","line":31,"column":24,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":31,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .logicOperator on an `any` value.","line":39,"column":21,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":39,"endColumn":34},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .field on an `any` value.","line":55,"column":16,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":55,"endColumn":21},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":56,"column":32,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":56,"endColumn":42},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .value on an `any` value.","line":56,"column":37,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":56,"endColumn":42},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .operator on an `any` value.","line":58,"column":20,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":58,"endColumn":28},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .operator on an `any` value.","line":60,"column":25,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":60,"endColumn":33},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .operator on an `any` value.","line":62,"column":25,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":62,"endColumn":33},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .operator on an `any` value.","line":64,"column":25,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":64,"endColumn":33},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .field on an `any` value.","line":69,"column":16,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":69,"endColumn":21},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .value on an `any` value.","line":69,"column":41,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":69,"endColumn":46},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":71,"column":19,"nodeType":"Property","messageId":"anyAssignment","endLine":71,"endColumn":39},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .value on an `any` value.","line":71,"column":34,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":71,"endColumn":39},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .field on an `any` value.","line":75,"column":16,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":75,"endColumn":21},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .value on an `any` value.","line":75,"column":42,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":75,"endColumn":47},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":77,"column":20,"nodeType":"Property","messageId":"anyAssignment","endLine":77,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .value on an `any` value.","line":77,"column":33,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":77,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":87,"column":11,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":87,"endColumn":45},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":106,"column":29,"nodeType":"Property","messageId":"anyAssignment","endLine":106,"endColumn":42},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":108,"column":36,"nodeType":"Property","messageId":"anyAssignment","endLine":108,"endColumn":49},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":110,"column":29,"nodeType":"Property","messageId":"anyAssignment","endLine":110,"endColumn":44},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":116,"column":29,"nodeType":"Property","messageId":"anyAssignment","endLine":116,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":118,"column":29,"nodeType":"Property","messageId":"anyAssignment","endLine":118,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":2,"message":"Unsafe call of a(n) `any` typed value.","line":125,"column":9,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":125,"endColumn":29},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .event on an `any` value.","line":125,"column":15,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":125,"endColumn":20},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":2,"message":"Unsafe call of a(n) `any` typed value.","line":125,"column":43,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":125,"endColumn":63},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .event on an `any` value.","line":125,"column":49,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":125,"endColumn":54},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .filters on an `any` value.","line":126,"column":18,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":126,"endColumn":25},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .filters on an `any` value.","line":126,"column":35,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":126,"endColumn":42},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .type on an `any` value.","line":130,"column":22,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":130,"endColumn":26},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .filters on an `any` value.","line":137,"column":29,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":137,"endColumn":36},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":138,"column":15,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":138,"endColumn":31},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .value on an `any` value.","line":138,"column":26,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":138,"endColumn":31},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":141,"column":62,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":141,"endColumn":69},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .field on an `any` value.","line":141,"column":64,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":141,"endColumn":69},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .operator on an `any` value.","line":142,"column":17,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":142,"endColumn":25},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .operator on an `any` value.","line":144,"column":22,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":144,"endColumn":30},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .operator on an `any` value.","line":146,"column":22,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":146,"endColumn":30},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":148,"column":60,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":148,"endColumn":67},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .field on an `any` value.","line":148,"column":62,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":148,"endColumn":67},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .operator on an `any` value.","line":151,"column":19,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":151,"endColumn":27},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .operator on an `any` value.","line":153,"column":24,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":153,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .operator on an `any` value.","line":155,"column":24,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":155,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":161,"column":68,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":161,"endColumn":75},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .field on an `any` value.","line":161,"column":70,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":161,"endColumn":75},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `TransactionWhereInput`.","line":162,"column":27,"nodeType":"TSAsExpression","messageId":"unsafeArgument","endLine":166,"endColumn":19},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":164,"column":34,"nodeType":"Property","messageId":"anyAssignment","endLine":164,"endColumn":46},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":168,"column":64,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":168,"endColumn":71},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .field on an `any` value.","line":168,"column":66,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":168,"endColumn":71},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `TransactionWhereInput`.","line":170,"column":27,"nodeType":"TSAsExpression","messageId":"unsafeArgument","endLine":174,"endColumn":19},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":172,"column":34,"nodeType":"Property","messageId":"anyAssignment","endLine":172,"endColumn":50},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .type on an `any` value.","line":182,"column":22,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":182,"endColumn":26}],"suppressedMessages":[],"errorCount":52,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Injectable } from '@nestjs/common';\r\nimport { Prisma } from '@prisma/client';\r\n\r\n@Injectable()\r\nexport class SegmentationQueryBuilder {\r\n  public build(rules: any[]): Prisma.CustomerWhereInput {\r\n    if (!rules || rules.length === 0) return {};\r\n\r\n    // Se for o formato antigo (array de regras diretas)\r\n    if (\r\n      rules.length > 0 &&\r\n      rules[0].field &&\r\n      rules[0].operator &&\r\n      !rules[0].category\r\n    ) {\r\n      return this.buildFromLegacyRules(rules);\r\n    }\r\n\r\n    const andConditions: Prisma.CustomerWhereInput[] = [];\r\n    const orConditions: Prisma.CustomerWhereInput[] = [];\r\n\r\n    rules.forEach((block, index) => {\r\n      let condition: Prisma.CustomerWhereInput | undefined;\r\n\r\n      if (block.category === 'characteristic') {\r\n        condition = this.mapCharacteristicToPrisma(block);\r\n      } else if (block.category === 'rfm') {\r\n        condition = {\r\n          rfmStatus: { contains: block.status, mode: 'insensitive' },\r\n        };\r\n      } else if (block.category === 'behavioral') {\r\n        condition = this.mapBehaviorToPrisma(block);\r\n      }\r\n\r\n      if (condition && Object.keys(condition).length > 0) {\r\n        if (index === 0) {\r\n          andConditions.push(condition);\r\n        } else {\r\n          if (block.logicOperator === 'OR') orConditions.push(condition);\r\n          else andConditions.push(condition);\r\n        }\r\n      }\r\n    });\r\n\r\n    if (orConditions.length > 0) {\r\n      return { AND: [...andConditions, { OR: orConditions }] };\r\n    }\r\n    return { AND: andConditions };\r\n  }\r\n\r\n  private buildFromLegacyRules(rules: any[]): Prisma.CustomerWhereInput {\r\n    const conditions: Prisma.CustomerWhereInput[] = [];\r\n\r\n    for (const rule of rules) {\r\n      if (rule.field === 'total_spent') {\r\n        const val = parseFloat(rule.value);\r\n        if (!isNaN(val)) {\r\n          if (rule.operator === 'gt')\r\n            conditions.push({ totalSpent: { gt: val } });\r\n          else if (rule.operator === 'lt')\r\n            conditions.push({ totalSpent: { lt: val } });\r\n          else if (rule.operator === 'gte')\r\n            conditions.push({ totalSpent: { gte: val } });\r\n          else if (rule.operator === 'lte')\r\n            conditions.push({ totalSpent: { lte: val } });\r\n        }\r\n      }\r\n\r\n      if (rule.field === 'city' && rule.value) {\r\n        conditions.push({\r\n          city: { contains: rule.value, mode: 'insensitive' },\r\n        });\r\n      }\r\n\r\n      if (rule.field === 'state' && rule.value) {\r\n        conditions.push({\r\n          state: { equals: rule.value, mode: 'insensitive' },\r\n        });\r\n      }\r\n    }\r\n\r\n    if (conditions.length === 0) return {};\r\n    return { AND: conditions };\r\n  }\r\n\r\n  private mapCharacteristicToPrisma(block: any): Prisma.CustomerWhereInput {\r\n    const { field, operator, value } = block;\r\n    const mode = 'insensitive';\r\n\r\n    if (field === 'totalSpent' || field === 'ordersCount') {\r\n      const numVal = Number(value);\r\n      if (operator === 'greater_than' || operator === 'gt')\r\n        return { [field]: { gt: numVal } };\r\n      if (operator === 'less_than' || operator === 'lt')\r\n        return { [field]: { lt: numVal } };\r\n      if (operator === 'equals' || operator === 'eq')\r\n        return { [field]: { equals: numVal } };\r\n      if (operator === 'greater_than_equals' || operator === 'gte')\r\n        return { [field]: { gte: numVal } };\r\n      if (operator === 'less_than_equals' || operator === 'lte')\r\n        return { [field]: { lte: numVal } };\r\n    }\r\n\r\n    switch (operator) {\r\n      case 'equals':\r\n        return { [field]: { equals: value, mode } };\r\n      case 'not_equals':\r\n        return { [field]: { not: { equals: value, mode } } };\r\n      case 'contains':\r\n        return { [field]: { contains: value, mode } };\r\n      case 'is_set':\r\n        return { [field]: { not: null } };\r\n      case 'is':\r\n        return { [field]: value === 'true' };\r\n      case 'greater_than':\r\n        return { [field]: { gt: value } };\r\n      case 'less_than':\r\n        return { [field]: { lt: value } };\r\n      default:\r\n        return {};\r\n    }\r\n  }\r\n\r\n  private mapBehaviorToPrisma(block: any): Prisma.CustomerWhereInput {\r\n    if (block.event.includes('pedido') || block.event.includes('comprou')) {\r\n      if (!block.filters || block.filters.length === 0) {\r\n        const basicCondition: Prisma.CustomerWhereInput = {\r\n          transactions: { some: {} },\r\n        };\r\n        return block.type === 'did_not'\r\n          ? { NOT: basicCondition }\r\n          : basicCondition;\r\n      }\r\n\r\n      const andFilters: Prisma.TransactionWhereInput[] = [];\r\n\r\n      for (const f of block.filters) {\r\n        const rawVal = f.value;\r\n        const numVal = Number(String(rawVal).replace(/[^0-9.-]+/g, '')) || 0;\r\n\r\n        if (['total', 'subtotal', 'valor', 'price'].includes(f.field)) {\r\n          if (f.operator === 'greater_than')\r\n            andFilters.push({ totalValue: { gt: numVal } });\r\n          else if (f.operator === 'less_than')\r\n            andFilters.push({ totalValue: { lt: numVal } });\r\n          else if (f.operator === 'equals')\r\n            andFilters.push({ totalValue: { equals: numVal } });\r\n        } else if (['date', 'data', 'created_at'].includes(f.field)) {\r\n          const dateVal = this.parseRelativeDate(String(rawVal));\r\n          if (dateVal) {\r\n            if (f.operator === 'greater_than')\r\n              andFilters.push({ date: { gte: dateVal } });\r\n            else if (f.operator === 'less_than')\r\n              andFilters.push({ date: { lte: dateVal } });\r\n            else if (f.operator === 'equals') {\r\n              const nextDay = new Date(dateVal);\r\n              nextDay.setDate(nextDay.getDate() + 1);\r\n              andFilters.push({ date: { gte: dateVal, lt: nextDay } });\r\n            }\r\n          }\r\n        } else if (['produto_id', 'nome_produto', 'name'].includes(f.field)) {\r\n          andFilters.push({\r\n            items: {\r\n              array_contains: [{ name: rawVal }],\r\n            },\r\n          } as any);\r\n        } else if (\r\n          ['categoria', 'category', 'nome_categoria'].includes(f.field)\r\n        ) {\r\n          andFilters.push({\r\n            items: {\r\n              array_contains: [{ category: rawVal }],\r\n            },\r\n          } as any);\r\n        }\r\n      }\r\n\r\n      if (andFilters.length > 0) {\r\n        const relationCondition: Prisma.CustomerWhereInput = {\r\n          transactions: { some: { AND: andFilters } },\r\n        };\r\n        return block.type === 'did_not'\r\n          ? { NOT: relationCondition }\r\n          : relationCondition;\r\n      }\r\n\r\n      return { transactions: { some: {} } };\r\n    }\r\n\r\n    return {};\r\n  }\r\n\r\n  private parseRelativeDate(value: string): Date | null {\r\n    const now = new Date();\r\n    if (value === 'Hoje') return new Date(now.setHours(0, 0, 0, 0));\r\n    if (value === 'Ontem') {\r\n      const d = new Date();\r\n      d.setDate(d.getDate() - 1);\r\n      d.setHours(0, 0, 0, 0);\r\n      return d;\r\n    }\r\n\r\n    if (value.includes('├Ültimos')) {\r\n      const days = parseInt(value.replace(/\\D/g, '')) || 30;\r\n      const d = new Date();\r\n      d.setDate(d.getDate() - days);\r\n      return d;\r\n    }\r\n    const parsed = new Date(value);\r\n    return isNaN(parsed.getTime()) ? null : parsed;\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\danie\\OneDrive\\Documentos\\CRM-PROJETO\\backend\\src\\modules\\erp\\customers\\customers.controller.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\danie\\OneDrive\\Documentos\\CRM-PROJETO\\backend\\src\\modules\\erp\\customers\\customers.module.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\danie\\OneDrive\\Documentos\\CRM-PROJETO\\backend\\src\\modules\\erp\\customers\\customers.service.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\danie\\OneDrive\\Documentos\\CRM-PROJETO\\backend\\src\\modules\\erp\\erp.module.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\danie\\OneDrive\\Documentos\\CRM-PROJETO\\backend\\src\\modules\\erp\\millenium\\millenium.service.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .$top on an `any` value.","line":65,"column":37,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":65,"endColumn":41},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .limit on an `any` value.","line":66,"column":36,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":66,"endColumn":41},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":73,"column":13,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":73,"endColumn":51},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'limit' is assigned a value but never used.","line":73,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":73,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'$top' is assigned a value but never used.","line":73,"column":22,"nodeType":null,"messageId":"unusedVar","endLine":73,"endColumn":26},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":78,"column":13,"nodeType":"Property","messageId":"anyAssignment","endLine":83,"endColumn":14},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":87,"column":15,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":87,"endColumn":53},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .value on an `any` value.","line":87,"column":42,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":87,"endColumn":47},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .length on an `any` value.","line":89,"column":24,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":89,"endColumn":30},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe spread of an `any` type.","line":90,"column":25,"nodeType":"SpreadElement","messageId":"unsafeSpread","endLine":90,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .length on an `any` value.","line":93,"column":26,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":93,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":2,"message":"Unsafe return of a value of type `any[]`.","line":112,"column":7,"nodeType":"ReturnStatement","messageId":"unsafeReturn","endLine":118,"endColumn":11},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":2,"message":"Unsafe return of a value of type `any`.","line":112,"column":38,"nodeType":"ObjectExpression","messageId":"unsafeReturn","endLine":118,"endColumn":8},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":114,"column":51,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":114,"endColumn":68},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .data_emissao on an `any` value.","line":114,"column":56,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":114,"endColumn":68},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":115,"column":51,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":115,"endColumn":68},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .data_entrega on an `any` value.","line":115,"column":56,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":115,"endColumn":68},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":117,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":117,"endColumn":78},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .dados_cliente on an `any` value.","line":117,"column":31,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":117,"endColumn":44},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .cliente on an `any` value.","line":117,"column":71,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":117,"endColumn":78},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .message on an `any` value.","line":120,"column":56,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":120,"endColumn":63},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .stack on an `any` value.","line":120,"column":73,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":120,"endColumn":78},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":2,"message":"Unsafe return of a value of type `any`.","line":136,"column":7,"nodeType":"ReturnStatement","messageId":"unsafeReturn","endLine":136,"endColumn":47},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .value on an `any` value.","line":136,"column":28,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":136,"endColumn":33},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .message on an `any` value.","line":139,"column":56,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":139,"endColumn":63},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":159,"column":13,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":159,"endColumn":49},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .value on an `any` value.","line":159,"column":38,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":159,"endColumn":43},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":162,"column":7,"nodeType":"AssignmentExpression","messageId":"anyAssignment","endLine":162,"endColumn":58},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":2,"message":"Unsafe call of a(n) `any` typed value.","line":162,"column":28,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":162,"endColumn":40},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .map on an `any` value.","line":162,"column":37,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":162,"endColumn":40},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":2,"message":"Unsafe return of a value of type `any`.","line":162,"column":48,"nodeType":"MemberExpression","messageId":"unsafeReturn","endLine":162,"endColumn":57},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .vitrine on an `any` value.","line":162,"column":50,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":162,"endColumn":57},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .message on an `any` value.","line":166,"column":58,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":166,"endColumn":65},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":192,"column":15,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":192,"endColumn":49},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .value on an `any` value.","line":192,"column":39,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":192,"endColumn":44},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":2,"message":"Unsafe return of a value of type `any`.","line":194,"column":11,"nodeType":"ReturnStatement","messageId":"unsafeReturn","endLine":194,"endColumn":26},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'error' is defined but never used.","line":196,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":196,"endColumn":21}],"suppressedMessages":[],"errorCount":34,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Injectable, Logger } from '@nestjs/common';\r\nimport { HttpService } from '@nestjs/axios';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport { lastValueFrom } from 'rxjs';\r\n\r\n@Injectable()\r\nexport class MilleniumService {\r\n  private readonly logger = new Logger(MilleniumService.name);\r\n  private readonly apiUrl: string;\r\n  private readonly vitrineId: number;\r\n  private vitrinesCache: number[] = [];\r\n\r\n  constructor(\r\n    private readonly httpService: HttpService,\r\n    private readonly configService: ConfigService,\r\n  ) {\r\n    this.apiUrl = this.configService.get<string>(\r\n      'MILLENIUM_API_URL',\r\n      'http://api.millenium.com.br/api/millenium_eco',\r\n    );\r\n    this.vitrineId = Number(\r\n      this.configService.get<number>('MILLENIUM_VITRINE_ID', 2),\r\n    );\r\n\r\n    // Configure Authentication Interceptor\r\n    const username = this.configService.get<string>('MILLENIUM_API_USERNAME');\r\n    const password = this.configService.get<string>('MILLENIUM_API_PASSWORD');\r\n\r\n    if (username && password) {\r\n      // Axios Basic Auth\r\n      this.httpService.axiosRef.interceptors.request.use((config) => {\r\n        const token = Buffer.from(`${username}:${password}`).toString('base64');\r\n        config.headers['Authorization'] = `Basic ${token}`;\r\n        return config;\r\n      });\r\n      this.logger.log('Basic Auth configured for Millenium API');\r\n    } else {\r\n      this.logger.warn(\r\n        'No credentials found for Millenium API (MILLENIUM_API_USERNAME/PASSWORD)',\r\n      );\r\n    }\r\n  }\r\n\r\n  private parseAspNetDate(dateStr: string): Date | null {\r\n    if (!dateStr || typeof dateStr !== 'string') return null;\r\n    // Format: /Date(1552532400000-180)/\r\n    const match = dateStr.match(/\\/Date\\((\\d+)([+-]\\d+)?\\)\\//);\r\n    if (match) {\r\n      const timestamp = parseInt(match[1], 10);\r\n      return new Date(timestamp);\r\n    }\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Fetches sales orders from Millenium API using pagination.\r\n   * Supports filtering by date, status, etc.\r\n   *\r\n   * @param params Query parameters (limit, $top, custom filters).\r\n   * @returns {Promise<any[]>} List of sales orders with parsed dates.\r\n   */\r\n  async getSales(params: any = {}) {\r\n    const allSales: any[] = [];\r\n    let skip = 0;\r\n    const batchSize = Number(params.$top) || 50;\r\n    const maxItems = Number(params.limit) || 5000;\r\n    let hasMore = true;\r\n\r\n    this.logger.log(`Fetching sales with params: ${JSON.stringify(params)}`);\r\n\r\n    try {\r\n      // Separate internal params from API params\r\n      const { limit, $top, ...apiParams } = params;\r\n\r\n      while (hasMore) {\r\n        const response = await lastValueFrom(\r\n          this.httpService.get(`${this.apiUrl}/pedido_venda/consulta`, {\r\n            params: {\r\n              ...apiParams,\r\n              $format: 'json',\r\n              $skip: skip,\r\n              $top: batchSize,\r\n            },\r\n          }),\r\n        );\r\n\r\n        const salesBatch = response.data.value || [];\r\n\r\n        if (salesBatch.length > 0) {\r\n          allSales.push(...salesBatch);\r\n          skip += batchSize;\r\n          // Microsoft OData logic: if batch < limit, we are done.\r\n          if (salesBatch.length < batchSize) {\r\n            hasMore = false;\r\n          }\r\n        } else {\r\n          hasMore = false;\r\n        }\r\n\r\n        // Check user defined limit\r\n        if (allSales.length >= maxItems) {\r\n          this.logger.log(\r\n            `Reached requested limit of ${maxItems} items. Stopping.`,\r\n          );\r\n          break;\r\n        }\r\n      }\r\n\r\n      this.logger.log(`Total sales fetched: ${allSales.length}`);\r\n\r\n      // Pre-process dates\r\n      return allSales.map((sale) => ({\r\n        ...sale,\r\n        data_emissao_parsed: this.parseAspNetDate(sale.data_emissao),\r\n        data_entrega_parsed: this.parseAspNetDate(sale.data_entrega),\r\n        // Helper to get customer ID safely\r\n        cliente_id_safe: sale.dados_cliente?.[0]?.cod_cliente || sale.cliente,\r\n      }));\r\n    } catch (error) {\r\n      this.logger.error(`Error fetching sales: ${error.message}`, error.stack);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Fetches details for a specific customer by ID.\r\n   * @returns {Promise<any | null>} Customer object or null if not found.\r\n   */\r\n  async getCustomer(clienteId: string | number) {\r\n    try {\r\n      const response = await lastValueFrom(\r\n        this.httpService.get(`${this.apiUrl}/clientes/lista`, {\r\n          params: { cliente: clienteId, $format: 'json' },\r\n        }),\r\n      );\r\n      return response.data.value?.[0] || null;\r\n    } catch (error) {\r\n      this.logger.warn(\r\n        `Error fetching customer ${clienteId}: ${error.message}`,\r\n      );\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Retrieves list of available Vitrines (Catalogs/Storefronts).\r\n   * Caches the result in memory.\r\n   */\r\n  async getVitrines(): Promise<number[]> {\r\n    try {\r\n      if (this.vitrinesCache.length > 0) return this.vitrinesCache;\r\n\r\n      const response = await lastValueFrom(\r\n        this.httpService.get(`${this.apiUrl}/vitrine/listatabelas`, {\r\n          params: { $format: 'json' },\r\n        }),\r\n      );\r\n\r\n      const vitrines = response.data.value || [];\r\n      // Store IDs. If user configured a PREFERRED id, maybe put it first?\r\n      // For now, just trust the list order or sort.\r\n      this.vitrinesCache = vitrines.map((v) => v.vitrine);\r\n      this.logger.log(`Loaded vitrines: ${this.vitrinesCache.join(', ')}`);\r\n      return this.vitrinesCache;\r\n    } catch (error) {\r\n      this.logger.warn(`Error fetching vitrines: ${error.message}`);\r\n      // Fallback to config or default 2\r\n      return [this.vitrineId || 2];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Searches for product details across all available vitrines.\r\n   * Returns the first match found.\r\n   */\r\n  async getProductDetails(produtoId: string | number) {\r\n    const vitrines = await this.getVitrines();\r\n\r\n    for (const vitrine of vitrines) {\r\n      try {\r\n        const response = await lastValueFrom(\r\n          this.httpService.get(`${this.apiUrl}/produtos/listavitrine`, {\r\n            params: {\r\n              produto: produtoId,\r\n              vitrine: vitrine,\r\n              $format: 'json',\r\n              $top: 1,\r\n            },\r\n          }),\r\n        );\r\n\r\n        const product = response.data.value?.[0];\r\n        if (product) {\r\n          return product; // Found it!\r\n        }\r\n      } catch (error) {\r\n        // Silent fail, try next vitrine\r\n        continue;\r\n      }\r\n    }\r\n\r\n    this.logger.warn(\r\n      `Product ${produtoId} not found in any vitrine (${vitrines.join(',')})`,\r\n    );\r\n    return null;\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\danie\\OneDrive\\Documentos\\CRM-PROJETO\\backend\\src\\modules\\erp\\sales\\dto\\create-sale.dto.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\danie\\OneDrive\\Documentos\\CRM-PROJETO\\backend\\src\\modules\\erp\\sales\\sales.controller.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\danie\\OneDrive\\Documentos\\CRM-PROJETO\\backend\\src\\modules\\erp\\sales\\sales.module.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'PrismaService' is defined but never used.","line":4,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":23}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Module } from '@nestjs/common';\r\nimport { SalesController } from './sales.controller';\r\nimport { SalesService } from './sales.service';\r\nimport { PrismaService } from 'src/prisma/prisma.service';\r\n\r\n@Module({\r\n  controllers: [SalesController],\r\n  providers: [SalesService],\r\n  // N├úo precisamos exportar o service a menos que outro m├│dulo v├í usar\r\n})\r\nexport class SalesModule {}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\danie\\OneDrive\\Documentos\\CRM-PROJETO\\backend\\src\\modules\\erp\\sales\\sales.service.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":35,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":35,"endColumn":26},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":81,"column":15,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":81,"endColumn":44},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .vendas on an `any` value.","line":82,"column":17,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":82,"endColumn":23},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .total on an `any` value.","line":83,"column":17,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":83,"endColumn":22},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":2,"message":"Unsafe return of a value of type `any[]`.","line":86,"column":5,"nodeType":"ReturnStatement","messageId":"unsafeReturn","endLine":86,"endColumn":44},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .channel on an `any` value.","line":161,"column":18,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":161,"endColumn":25},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .channel on an `any` value.","line":161,"column":37,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":161,"endColumn":44},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":163,"column":7,"nodeType":"AssignmentExpression","messageId":"anyAssignment","endLine":163,"endColumn":70},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access [filters.channel] on an `any` value.","line":163,"column":35,"nodeType":"MemberExpression","messageId":"unsafeMemberExpression","endLine":163,"endColumn":50},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Computed name [filters.channel] resolves to an `any` value.","line":163,"column":35,"nodeType":"MemberExpression","messageId":"unsafeComputedMemberAccess","endLine":163,"endColumn":50},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .channel on an `any` value.","line":163,"column":43,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":163,"endColumn":50},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .channel on an `any` value.","line":163,"column":63,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":163,"endColumn":70},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .campaignIds on an `any` value.","line":165,"column":18,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":165,"endColumn":29},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":166,"column":28,"nodeType":"Property","messageId":"anyAssignment","endLine":166,"endColumn":51},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .campaignIds on an `any` value.","line":166,"column":40,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":166,"endColumn":51},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .tags on an `any` value.","line":167,"column":18,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":167,"endColumn":22},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":167,"column":55,"nodeType":"Property","messageId":"anyAssignment","endLine":167,"endColumn":76},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .tags on an `any` value.","line":167,"column":72,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":167,"endColumn":76},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .campaignType on an `any` value.","line":169,"column":16,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":169,"endColumn":28},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":2,"message":"Unsafe call of a(n) `any` typed value.","line":170,"column":8,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":170,"endColumn":37},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .campaignType on an `any` value.","line":170,"column":16,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":170,"endColumn":28},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":172,"column":30,"nodeType":"Property","messageId":"anyAssignment","endLine":172,"endColumn":54},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .campaignType on an `any` value.","line":172,"column":42,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":172,"endColumn":54},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string | number | Date`.","line":235,"column":26,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":235,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .date on an `any` value.","line":235,"column":28,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":235,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string | number | Date`.","line":235,"column":55,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":235,"endColumn":61},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .date on an `any` value.","line":235,"column":57,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":235,"endColumn":61},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":321,"column":13,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":321,"endColumn":41},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .revenue on an `any` value.","line":322,"column":9,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":322,"endColumn":16},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .revenueInfluenced on an `any` value.","line":324,"column":11,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":324,"endColumn":28},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .conversoes on an `any` value.","line":325,"column":11,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":325,"endColumn":21},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .salesInfluenced on an `any` value.","line":326,"column":11,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":326,"endColumn":26},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":2,"message":"Unsafe return of a value of type `any`.","line":333,"column":67,"nodeType":"ObjectExpression","messageId":"unsafeReturn","endLine":337,"endColumn":8},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .conversoes on an `any` value.","line":336,"column":13,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":336,"endColumn":23},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .revenueInfluenced on an `any` value.","line":336,"column":32,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":336,"endColumn":49},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .conversoes on an `any` value.","line":336,"column":54,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":336,"endColumn":64},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .storeId on an `any` value.","line":362,"column":54,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":362,"endColumn":61},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":365,"column":7,"nodeType":"Property","messageId":"anyAssignment","endLine":365,"endColumn":25},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":420,"column":13,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":420,"endColumn":43},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .revenue on an `any` value.","line":421,"column":12,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":421,"endColumn":19},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .transactions on an `any` value.","line":422,"column":12,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":422,"endColumn":24},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .revenueInfluenced on an `any` value.","line":423,"column":30,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":423,"endColumn":47},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":2,"message":"Unsafe call of a(n) `any` typed value.","line":424,"column":7,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":424,"endColumn":27},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .customerSet on an `any` value.","line":424,"column":12,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":424,"endColumn":23},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .groupNew on an `any` value.","line":426,"column":37,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":426,"endColumn":45},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .groupRecurrent on an `any` value.","line":427,"column":48,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":427,"endColumn":62},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .groupRecovered on an `any` value.","line":428,"column":17,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":428,"endColumn":31},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":441,"column":13,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":441,"endColumn":40},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .revenue on an `any` value.","line":442,"column":10,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":442,"endColumn":17},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .transactions on an `any` value.","line":443,"column":10,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":443,"endColumn":22},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .revenueInfluenced on an `any` value.","line":444,"column":28,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":444,"endColumn":45},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .recurrentCount on an `any` value.","line":445,"column":41,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":445,"endColumn":55},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .value on an `any` value.","line":449,"column":32,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":449,"endColumn":37},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":2,"message":"Unsafe return of a value of type `any`.","line":453,"column":26,"nodeType":"ObjectExpression","messageId":"unsafeReturn","endLine":459,"endColumn":8},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .value on an `any` value.","line":457,"column":20,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":457,"endColumn":25},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .value on an `any` value.","line":460,"column":25,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":460,"endColumn":30},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .value on an `any` value.","line":460,"column":35,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":460,"endColumn":40},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .transactions on an `any` value.","line":464,"column":26,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":464,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .revenue on an `any` value.","line":464,"column":47,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":464,"endColumn":54},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .transactions on an `any` value.","line":464,"column":59,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":464,"endColumn":71},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":2,"message":"Unsafe return of a value of type `any`.","line":465,"column":9,"nodeType":"ReturnStatement","messageId":"unsafeReturn","endLine":477,"endColumn":11},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .revenue on an `any` value.","line":469,"column":15,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":469,"endColumn":22},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .revenueInfluenced on an `any` value.","line":470,"column":21,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":470,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .revenue on an `any` value.","line":470,"column":43,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":470,"endColumn":50},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .transactions on an `any` value.","line":473,"column":15,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":473,"endColumn":27},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .recurrentCount on an `any` value.","line":474,"column":21,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":474,"endColumn":35},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .transactions on an `any` value.","line":474,"column":40,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":474,"endColumn":52},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .revenue on an `any` value.","line":479,"column":25,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":479,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .revenue on an `any` value.","line":479,"column":37,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":479,"endColumn":44},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .sortDate on an `any` value.","line":482,"column":35,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":482,"endColumn":43},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .sortDate on an `any` value.","line":482,"column":48,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":482,"endColumn":56},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":484,"column":15,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":484,"endColumn":51},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .customerSet on an `any` value.","line":484,"column":35,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":484,"endColumn":46},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .transactions on an `any` value.","line":485,"column":26,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":485,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .revenue on an `any` value.","line":485,"column":47,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":485,"endColumn":54},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .transactions on an `any` value.","line":485,"column":59,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":485,"endColumn":71},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":2,"message":"Unsafe return of a value of type `any`.","line":486,"column":9,"nodeType":"ReturnStatement","messageId":"unsafeReturn","endLine":514,"endColumn":11},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .revenue on an `any` value.","line":488,"column":29,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":488,"endColumn":36},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .revenueInfluenced on an `any` value.","line":488,"column":41,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":488,"endColumn":58},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .transactions on an `any` value.","line":492,"column":15,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":492,"endColumn":27},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .groupRecurrent on an `any` value.","line":493,"column":28,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":493,"endColumn":42},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .transactions on an `any` value.","line":493,"column":47,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":493,"endColumn":59},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .revenue on an `any` value.","line":495,"column":30,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":495,"endColumn":37},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":496,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":496,"endColumn":37},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .revenue on an `any` value.","line":499,"column":48,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":499,"endColumn":55},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .transactions on an `any` value.","line":502,"column":27,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":502,"endColumn":39},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .transactions on an `any` value.","line":506,"column":36,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":506,"endColumn":48},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .groupNew on an `any` value.","line":509,"column":27,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":509,"endColumn":35},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .transactions on an `any` value.","line":509,"column":40,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":509,"endColumn":52},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .revenue on an `any` value.","line":509,"column":58,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":509,"endColumn":65},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .groupRecurrent on an `any` value.","line":511,"column":27,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":511,"endColumn":41},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .transactions on an `any` value.","line":511,"column":46,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":511,"endColumn":58},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .revenue on an `any` value.","line":511,"column":64,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":511,"endColumn":71},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .groupRecovered on an `any` value.","line":513,"column":27,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":513,"endColumn":41},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .transactions on an `any` value.","line":513,"column":46,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":513,"endColumn":58},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .revenue on an `any` value.","line":513,"column":64,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":513,"endColumn":71},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":2,"message":"Unsafe return of a value of type `any`.","line":518,"column":50,"nodeType":"ObjectExpression","messageId":"unsafeReturn","endLine":521,"endColumn":6},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":520,"column":7,"nodeType":"Property","messageId":"anyAssignment","endLine":520,"endColumn":61},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":2,"message":"Unsafe call of a(n) `any` typed value.","line":520,"column":13,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":520,"endColumn":41},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":2,"message":"Unsafe call of a(n) `any` typed value.","line":520,"column":13,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":520,"endColumn":26},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .name on an `any` value.","line":520,"column":15,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":520,"endColumn":19},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .toUpperCase on an `any` value.","line":520,"column":30,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":520,"endColumn":41},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":2,"message":"Unsafe call of a(n) `any` typed value.","line":520,"column":46,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":520,"endColumn":58},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .name on an `any` value.","line":520,"column":48,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":520,"endColumn":52},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .channel on an `any` value.","line":563,"column":18,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":563,"endColumn":25},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .channel on an `any` value.","line":563,"column":37,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":563,"endColumn":44},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":565,"column":13,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":565,"endColumn":58},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access [filters.channel] on an `any` value.","line":565,"column":23,"nodeType":"MemberExpression","messageId":"unsafeMemberExpression","endLine":565,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Computed name [filters.channel] resolves to an `any` value.","line":565,"column":23,"nodeType":"MemberExpression","messageId":"unsafeComputedMemberAccess","endLine":565,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .channel on an `any` value.","line":565,"column":31,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":565,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .channel on an `any` value.","line":565,"column":51,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":565,"endColumn":58},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":566,"column":7,"nodeType":"AssignmentExpression","messageId":"anyAssignment","endLine":566,"endColumn":34},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":567,"column":7,"nodeType":"AssignmentExpression","messageId":"anyAssignment","endLine":567,"endColumn":37},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .campaignIds on an `any` value.","line":569,"column":18,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":569,"endColumn":29},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":570,"column":28,"nodeType":"Property","messageId":"anyAssignment","endLine":570,"endColumn":51},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .campaignIds on an `any` value.","line":570,"column":40,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":570,"endColumn":51},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .tags on an `any` value.","line":571,"column":18,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":571,"endColumn":22},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":571,"column":55,"nodeType":"Property","messageId":"anyAssignment","endLine":571,"endColumn":76},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .tags on an `any` value.","line":571,"column":72,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":571,"endColumn":76},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .campaignType on an `any` value.","line":572,"column":18,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":572,"endColumn":30},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":573,"column":30,"nodeType":"Property","messageId":"anyAssignment","endLine":573,"endColumn":54},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .campaignType on an `any` value.","line":573,"column":42,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":573,"endColumn":54},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .storeIds on an `any` value.","line":574,"column":18,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":574,"endColumn":26},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":575,"column":33,"nodeType":"Property","messageId":"anyAssignment","endLine":575,"endColumn":53},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .storeIds on an `any` value.","line":575,"column":45,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":575,"endColumn":53},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":576,"column":36,"nodeType":"Property","messageId":"anyAssignment","endLine":576,"endColumn":56},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .storeIds on an `any` value.","line":576,"column":48,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":576,"endColumn":56},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":633,"column":15,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":633,"endColumn":35},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .realizados on an `any` value.","line":634,"column":11,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":634,"endColumn":21},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .confirmados on an `any` value.","line":635,"column":11,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":635,"endColumn":22},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .descadastros on an `any` value.","line":636,"column":11,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":636,"endColumn":23},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .disponibilizados on an `any` value.","line":637,"column":11,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":637,"endColumn":27},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":644,"column":15,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":644,"endColumn":35},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .receitaInf on an `any` value.","line":645,"column":11,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":645,"endColumn":21},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .vendasInf on an `any` value.","line":646,"column":11,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":646,"endColumn":20},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":2,"message":"Unsafe return of a value of type `any`.","line":652,"column":69,"nodeType":"ObjectExpression","messageId":"unsafeReturn","endLine":659,"endColumn":6},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":654,"column":7,"nodeType":"Property","messageId":"anyAssignment","endLine":654,"endColumn":28},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .receitaInf on an `any` value.","line":654,"column":18,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":654,"endColumn":28},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `number`.","line":655,"column":27,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":655,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .vendasInf on an `any` value.","line":655,"column":29,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":655,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `number`.","line":655,"column":40,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":655,"endColumn":52},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .realizados on an `any` value.","line":655,"column":42,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":655,"endColumn":52},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `number`.","line":656,"column":28,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":656,"endColumn":40},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .receitaInf on an `any` value.","line":656,"column":30,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":656,"endColumn":40},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `number`.","line":656,"column":42,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":656,"endColumn":54},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .realizados on an `any` value.","line":656,"column":44,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":656,"endColumn":54},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `number`.","line":657,"column":27,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":657,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .vendasInf on an `any` value.","line":657,"column":29,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":657,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `number`.","line":657,"column":40,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":657,"endColumn":52},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .realizados on an `any` value.","line":657,"column":42,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":657,"endColumn":52},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .realizados on an `any` value.","line":658,"column":18,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":658,"endColumn":28},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .confirmados on an `any` value.","line":658,"column":33,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":658,"endColumn":44},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":694,"column":13,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":694,"endColumn":42},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .disponibilizados on an `any` value.","line":695,"column":10,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":695,"endColumn":26},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .realizados on an `any` value.","line":696,"column":10,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":696,"endColumn":20},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .confirmados on an `any` value.","line":697,"column":10,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":697,"endColumn":21},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":701,"column":15,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":701,"endColumn":44},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .receitaInf on an `any` value.","line":702,"column":12,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":702,"endColumn":22},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .vendasInf on an `any` value.","line":703,"column":12,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":703,"endColumn":21},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":2,"message":"Unsafe return of a value of type `any`.","line":706,"column":73,"nodeType":"ObjectExpression","messageId":"unsafeReturn","endLine":712,"endColumn":6},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `number`.","line":708,"column":28,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":708,"endColumn":40},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .receitaInf on an `any` value.","line":708,"column":30,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":708,"endColumn":40},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `number`.","line":708,"column":42,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":708,"endColumn":54},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .realizados on an `any` value.","line":708,"column":44,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":708,"endColumn":54},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `number`.","line":709,"column":27,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":709,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .vendasInf on an `any` value.","line":709,"column":29,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":709,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `number`.","line":709,"column":40,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":709,"endColumn":52},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .realizados on an `any` value.","line":709,"column":42,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":709,"endColumn":52},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `number`.","line":710,"column":27,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":710,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .vendasInf on an `any` value.","line":710,"column":29,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":710,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `number`.","line":710,"column":40,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":710,"endColumn":52},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .realizados on an `any` value.","line":710,"column":42,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":710,"endColumn":52},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .realizados on an `any` value.","line":711,"column":18,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":711,"endColumn":28},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .confirmados on an `any` value.","line":711,"column":33,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":711,"endColumn":44},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":718,"column":15,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":718,"endColumn":67},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .name on an `any` value.","line":718,"column":53,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":718,"endColumn":57},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":725,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":725,"endColumn":20},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":734,"column":13,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":734,"endColumn":46},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .receitaInf on an `any` value.","line":735,"column":14,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":735,"endColumn":24},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .vendasInf on an `any` value.","line":736,"column":14,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":736,"endColumn":23},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":739,"column":13,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":739,"endColumn":50},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .storeId on an `any` value.","line":739,"column":42,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":739,"endColumn":49},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .disponibilizados on an `any` value.","line":742,"column":11,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":742,"endColumn":27},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .disponibilizados on an `any` value.","line":742,"column":52,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":742,"endColumn":68},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .realizados on an `any` value.","line":743,"column":11,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":743,"endColumn":21},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .realizados on an `any` value.","line":743,"column":46,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":743,"endColumn":56},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .confirmados on an `any` value.","line":744,"column":11,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":744,"endColumn":22},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .confirmados on an `any` value.","line":744,"column":47,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":744,"endColumn":58},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":2,"message":"Unsafe return of a value of type `any`.","line":746,"column":7,"nodeType":"ReturnStatement","messageId":"unsafeReturn","endLine":752,"endColumn":9},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `number`.","line":748,"column":30,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":748,"endColumn":42},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .receitaInf on an `any` value.","line":748,"column":32,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":748,"endColumn":42},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `number`.","line":748,"column":44,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":748,"endColumn":56},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .realizados on an `any` value.","line":748,"column":46,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":748,"endColumn":56},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `number`.","line":749,"column":29,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":749,"endColumn":40},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .vendasInf on an `any` value.","line":749,"column":31,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":749,"endColumn":40},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `number`.","line":749,"column":42,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":749,"endColumn":54},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .realizados on an `any` value.","line":749,"column":44,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":749,"endColumn":54},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `number`.","line":750,"column":29,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":750,"endColumn":40},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .vendasInf on an `any` value.","line":750,"column":31,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":750,"endColumn":40},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `number`.","line":750,"column":42,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":750,"endColumn":54},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .realizados on an `any` value.","line":750,"column":44,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":750,"endColumn":54},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .realizados on an `any` value.","line":751,"column":20,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":751,"endColumn":30},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .confirmados on an `any` value.","line":751,"column":35,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":751,"endColumn":46}],"suppressedMessages":[],"errorCount":183,"fatalErrorCount":0,"warningCount":20,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Injectable } from '@nestjs/common';\r\nimport { PrismaService } from 'src/prisma/prisma.service';\r\nimport { CreateSaleDto } from './dto/create-sale.dto';\r\nimport { Prisma } from '@prisma/client';\r\nimport { format, subDays, startOfDay, endOfDay } from 'date-fns';\r\nimport { ptBR } from 'date-fns/locale';\r\n\r\n@Injectable()\r\nexport class SalesService {\r\n  constructor(private prisma: PrismaService) {}\r\n\r\n  // --- M├ëTODOS B├üSICOS ---\r\n  /**\r\n   * Processes a new sale transaction.\r\n   * Creates or updates the customer record and logs the transaction.\r\n   * @param data DTO containing sale details (customer info, items, total).\r\n   */\r\n  async processSale(data: CreateSaleDto) {\r\n    const customer = await this.prisma.customer.upsert({\r\n      where: { email: data.customerEmail },\r\n      update: { name: data.customerName },\r\n      create: {\r\n        name: data.customerName,\r\n        email: data.customerEmail,\r\n        cpf: data.customerCpf,\r\n        storeId: data.storeId,\r\n      },\r\n    });\r\n    const transaction = await this.prisma.transaction.create({\r\n      data: {\r\n        storeId: data.storeId,\r\n        customerId: customer.id,\r\n        totalValue: data.totalValue,\r\n        date: new Date(),\r\n        items: data.items,\r\n        channel: data.channel || 'Loja F├¡sica',\r\n        isInfluenced: data.isInfluenced || false,\r\n        status: 'PAID', // Garante status pago\r\n      },\r\n    });\r\n    return { message: 'Venda processada!', transactionId: transaction.id };\r\n  }\r\n\r\n  /**\r\n   * Calculates the total sales value and count for the current day.\r\n   * Only considers 'PAID' transactions.\r\n   */\r\n  async getDailyTotal() {\r\n    const today = new Date();\r\n    const aggregate = await this.prisma.transaction.aggregate({\r\n      _sum: { totalValue: true },\r\n      _count: { id: true },\r\n      where: {\r\n        date: { gte: startOfDay(today), lte: endOfDay(today) },\r\n        status: 'PAID',\r\n      },\r\n    });\r\n    return {\r\n      total: Number(aggregate._sum.totalValue) || 0,\r\n      count: aggregate._count.id || 0,\r\n    };\r\n  }\r\n\r\n  async getSalesHistory() {\r\n    const endDate = new Date();\r\n    const startDate = subDays(endDate, 6);\r\n    startDate.setHours(0, 0, 0, 0);\r\n    const transactions = await this.prisma.transaction.findMany({\r\n      where: { date: { gte: startDate, lte: endDate }, status: 'PAID' },\r\n      orderBy: { date: 'asc' },\r\n    });\r\n    const historyMap = new Map();\r\n    for (let i = 0; i <= 6; i++) {\r\n      const d = subDays(endDate, 6 - i);\r\n      const key = format(d, 'dd/MM', { locale: ptBR });\r\n      historyMap.set(key, { name: key, vendas: 0, total: 0 });\r\n    }\r\n    transactions.forEach((tx) => {\r\n      const key = format(tx.date, 'dd/MM', { locale: ptBR });\r\n      if (historyMap.has(key)) {\r\n        const current = historyMap.get(key);\r\n        current.vendas += Number(tx.totalValue);\r\n        current.total += 1;\r\n      }\r\n    });\r\n    return Array.from(historyMap.values());\r\n  }\r\n\r\n  async getRecentSales() {\r\n    const sales = await this.prisma.transaction.findMany({\r\n      take: 5,\r\n      orderBy: { date: 'desc' },\r\n      where: { status: 'PAID' },\r\n      include: {\r\n        customer: { select: { name: true, email: true } },\r\n        store: { select: { name: true } },\r\n      },\r\n    });\r\n    return sales.map((s) => ({\r\n      id: s.id,\r\n      customer: s.customer?.name || 'Consumidor',\r\n      email: s.customer?.email,\r\n      store: s.store?.name,\r\n      value: Number(s.totalValue),\r\n      date: s.date,\r\n      channel: s.channel,\r\n    }));\r\n  }\r\n\r\n  async getStores() {\r\n    return this.prisma.store.findMany({\r\n      select: { id: true, name: true },\r\n      orderBy: { name: 'asc' },\r\n    });\r\n  }\r\n\r\n  // --- FILTROS ---\r\n  async getFilterOptions() {\r\n    const campaigns = await this.prisma.campaign.findMany({\r\n      select: { id: true, name: true, tags: true, type: true, channel: true },\r\n      orderBy: { date: 'desc' },\r\n      take: 2000,\r\n    });\r\n\r\n    const tagsSet = new Set<string>();\r\n    campaigns.forEach((c) => c.tags.forEach((t) => tagsSet.add(t)));\r\n    const typesSet = new Set<string>();\r\n    campaigns.forEach((c) => {\r\n      if (c.type) typesSet.add(c.type);\r\n    });\r\n    const stores = await this.prisma.store.findMany({\r\n      select: { id: true, name: true },\r\n    });\r\n\r\n    return {\r\n      campaigns: campaigns.map((c) => ({ id: c.id, name: c.name })),\r\n      tags: Array.from(tagsSet).sort(),\r\n      types: Array.from(typesSet).sort(),\r\n      stores: stores.map((s) => ({ id: s.id, name: s.name })),\r\n      channels: ['E-mail', 'SMS', 'Mobile push', 'WhatsApp'],\r\n    };\r\n  }\r\n\r\n  // --- L├ôGICA DO DASHBOARD DE CANAIS ---\r\n  /**\r\n   * Generates the Channel Dashboard data.\r\n   * enhanced with campaign performance, dispatch stats, and daily metrics.\r\n   *\r\n   * @param startDate Start date string (YYYY-MM-DD).\r\n   * @param endDate End date string (YYYY-MM-DD).\r\n   * @param filters Optional filters for channels, tags, etc.\r\n   */\r\n  async getChannelDashboard(startDate: string, endDate: string, filters?: any) {\r\n    const start = new Date(startDate);\r\n    const end = new Date(endDate);\r\n    end.setUTCHours(23, 59, 59, 999);\r\n\r\n    const campaignWhere: Prisma.CampaignWhereInput = {\r\n      date: { gte: start, lte: end },\r\n    };\r\n    if (filters?.channel && filters.channel !== 'Todos') {\r\n      const map: any = { 'Mobile push': 'Push', 'E-mail': 'Email' };\r\n      campaignWhere.channel = map[filters.channel] || filters.channel;\r\n    }\r\n    if (filters?.campaignIds?.length)\r\n      campaignWhere.id = { in: filters.campaignIds };\r\n    if (filters?.tags?.length) campaignWhere.tags = { hasSome: filters.tags };\r\n    if (\r\n      filters?.campaignType?.length &&\r\n      !filters.campaignType.includes('Todos')\r\n    )\r\n      campaignWhere.type = { in: filters.campaignType };\r\n\r\n    const campaignsRaw = await this.prisma.campaign.findMany({\r\n      where: campaignWhere,\r\n      orderBy: { date: 'desc' },\r\n      include: { schedules: true },\r\n    });\r\n\r\n    const salesRaw = await this.prisma.transaction.findMany({\r\n      where: { date: { gte: start, lte: end }, status: 'PAID' },\r\n      select: {\r\n        date: true,\r\n        totalValue: true,\r\n        id: true,\r\n        isInfluenced: true,\r\n        storeId: true,\r\n        store: { select: { name: true } },\r\n      },\r\n    });\r\n\r\n    const totalInfluencedRevenue = salesRaw\r\n      .filter((s) => s.isInfluenced)\r\n      .reduce((acc, s) => acc + Number(s.totalValue), 0);\r\n    const totalConversions = salesRaw.filter((s) => s.isInfluenced).length;\r\n    const totalClicks = campaignsRaw.reduce((acc, c) => acc + c.clicks, 0);\r\n\r\n    let dispatchesList: any[] = [];\r\n\r\n    campaignsRaw.forEach((camp) => {\r\n      const campaignShare = totalClicks > 0 ? camp.clicks / totalClicks : 0;\r\n      const campRevenue = totalInfluencedRevenue * campaignShare;\r\n      const campConversions = Math.floor(totalConversions * campaignShare);\r\n\r\n      if (camp.schedules && camp.schedules.length > 0) {\r\n        const share = 1 / camp.schedules.length;\r\n        camp.schedules.forEach((sch) => {\r\n          const dispRev = campRevenue * share;\r\n          const dispConv = campConversions * share;\r\n          dispatchesList.push({\r\n            id: sch.id,\r\n            campaignName: camp.name,\r\n            date: sch.sendDate,\r\n            status: 'Enviado',\r\n            sent: Math.floor(camp.sent * share),\r\n            revenue: dispRev,\r\n            conversions: dispConv,\r\n            ticket: dispConv > 0 ? dispRev / dispConv : 0,\r\n          });\r\n        });\r\n      } else {\r\n        dispatchesList.push({\r\n          id: camp.id + '-main',\r\n          campaignName: camp.name,\r\n          date: camp.date,\r\n          status: camp.status === 'sent' ? 'Conclu├¡do' : 'Agendado',\r\n          sent: camp.sent,\r\n          revenue: campRevenue,\r\n          conversions: campConversions,\r\n          ticket: campConversions > 0 ? campRevenue / campConversions : 0,\r\n        });\r\n      }\r\n    });\r\n    dispatchesList = dispatchesList.sort(\r\n      (a, b) => new Date(b.date).getTime() - new Date(a.date).getTime(),\r\n    );\r\n\r\n    const chartData: any[] = [];\r\n    const currentDate = new Date(start);\r\n    while (currentDate <= end) {\r\n      const dateStr = currentDate.toISOString().split('T')[0];\r\n      const dayLabel = `${currentDate.getUTCDate()}/${(currentDate.getUTCMonth() + 1).toString().padStart(2, '0')}`;\r\n      const salesOfDay = salesRaw.filter(\r\n        (s) => s.date.toISOString().split('T')[0] === dateStr,\r\n      );\r\n      const campsOfDay = campaignsRaw.filter(\r\n        (c) => new Date(c.date).toISOString().split('T')[0] === dateStr,\r\n      );\r\n\r\n      const metrics = campsOfDay.reduce(\r\n        (acc, curr) => ({\r\n          sent: acc.sent + (curr.sent || 0),\r\n          delivered: acc.delivered + (curr.delivered || 0),\r\n          opens: acc.opens + (curr.opens || 0),\r\n          clicks: acc.clicks + (curr.clicks || 0),\r\n          softBounces: acc.softBounces + (curr.softBounces || 0),\r\n          hardBounces: acc.hardBounces + (curr.hardBounces || 0),\r\n          spam: acc.spam + (curr.spamReports || 0),\r\n          unsub: acc.unsub + (curr.unsubscribes || 0),\r\n        }),\r\n        {\r\n          sent: 0,\r\n          delivered: 0,\r\n          opens: 0,\r\n          clicks: 0,\r\n          softBounces: 0,\r\n          hardBounces: 0,\r\n          spam: 0,\r\n          unsub: 0,\r\n        },\r\n      );\r\n\r\n      const revTotal = salesOfDay.reduce(\r\n        (acc, s) => acc + Number(s.totalValue),\r\n        0,\r\n      );\r\n      const revInf = salesOfDay\r\n        .filter((s) => s.isInfluenced)\r\n        .reduce((acc, s) => acc + Number(s.totalValue), 0);\r\n      const convs = salesOfDay.filter((s) => s.isInfluenced).length;\r\n\r\n      chartData.push({\r\n        name: dayLabel,\r\n        fullDate: dateStr,\r\n        envios: metrics.sent,\r\n        entregues: metrics.delivered,\r\n        aberturas: metrics.opens,\r\n        cliques: metrics.clicks,\r\n        ctr:\r\n          metrics.delivered > 0\r\n            ? (metrics.clicks / metrics.delivered) * 100\r\n            : 0,\r\n        ctor: metrics.opens > 0 ? (metrics.clicks / metrics.opens) * 100 : 0,\r\n        softBounces: metrics.softBounces,\r\n        hardBounces: metrics.hardBounces,\r\n        bounces: metrics.softBounces + metrics.hardBounces,\r\n        spam: metrics.spam,\r\n        descadastro: metrics.unsub,\r\n        rejeicoes: metrics.spam + metrics.unsub,\r\n        receitaTotal: Number(revTotal.toFixed(2)),\r\n        receitaInfluenciada: Number(revInf.toFixed(2)),\r\n        conversoes: convs,\r\n        ticket: convs > 0 ? revInf / convs : 0,\r\n        vendasInfluenciadas: convs,\r\n        baseInfluenciada: convs,\r\n      });\r\n      currentDate.setUTCDate(currentDate.getUTCDate() + 1);\r\n    }\r\n\r\n    const storesMap = new Map();\r\n    salesRaw.forEach((s) => {\r\n      if (!storesMap.has(s.storeId))\r\n        storesMap.set(s.storeId, {\r\n          id: s.storeId,\r\n          name: s.store?.name,\r\n          revenue: 0,\r\n          revenueInfluenced: 0,\r\n          conversions: 0,\r\n          salesInfluenced: 0,\r\n        });\r\n      const d = storesMap.get(s.storeId);\r\n      d.revenue += Number(s.totalValue);\r\n      if (s.isInfluenced) {\r\n        d.revenueInfluenced += Number(s.totalValue);\r\n        d.conversoes++;\r\n        d.salesInfluenced++;\r\n      }\r\n    });\r\n\r\n    return {\r\n      chart: chartData,\r\n      campaignsList: campaignsRaw,\r\n      storesList: Array.from(storesMap.values()).map((s: any) => ({\r\n        ...s,\r\n        ticketAverage:\r\n          s.conversoes > 0 ? s.revenueInfluenced / s.conversoes : 0,\r\n      })),\r\n      dispatchesList,\r\n      filterOptions: await this.getFilterOptions(),\r\n    };\r\n  }\r\n\r\n  // --- 3. DASHBOARD DE VAREJO (CORRIGIDO PARA RECEBER DATE) ---\r\n  /**\r\n   * Calculates Retail Metrics for the Results Dashboard.\r\n   * Includes KPIs, sales history, channel distribution, and store performance.\r\n   *\r\n   * @param start Start Date object.\r\n   * @param end End Date object.\r\n   * @param storeIds Optional array of store IDs to filter.\r\n   */\r\n  async getRetailMetrics(start: Date, end: Date, storeIds?: string[]) {\r\n    // Debug para verificar as datas que chegam\r\n    console.log(\r\n      `­ƒôè Buscando dados de ${start.toISOString()} at├® ${end.toISOString()}`,\r\n    );\r\n\r\n    const whereClause: any = {\r\n      date: { gte: start, lte: end },\r\n      status: 'PAID',\r\n    };\r\n    if (storeIds && storeIds.length > 0) whereClause.storeId = { in: storeIds };\r\n\r\n    const transactions = await this.prisma.transaction.findMany({\r\n      where: whereClause,\r\n      include: { store: true },\r\n      orderBy: { date: 'asc' },\r\n    });\r\n\r\n    let totalRevenue = 0;\r\n    const totalTransactions = transactions.length;\r\n\r\n    // Maps para agrega├º├úo\r\n    const historyMap = new Map();\r\n    const storesMap = new Map();\r\n    const channelsMap = new Map();\r\n    const customerHistory = new Map<string, Date>();\r\n\r\n    const diffTime = Math.abs(end.getTime() - start.getTime());\r\n    const isDaily = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) <= 60; // Se for menos de 60 dias, mostra por dia\r\n\r\n    for (const tx of transactions) {\r\n      const val = Number(tx.totalValue);\r\n      const storeId = tx.storeId;\r\n      const channel = tx.channel || 'Outros';\r\n      const isInfluenced = tx.isInfluenced || false;\r\n      const txDate = new Date(tx.date);\r\n\r\n      totalRevenue += val;\r\n\r\n      let groupType = 'new';\r\n      const lastPurchase = customerHistory.get(tx.customerId);\r\n      if (lastPurchase) {\r\n        const daysSinceLast = Math.floor(\r\n          (txDate.getTime() - lastPurchase.getTime()) / (1000 * 3600 * 24),\r\n        );\r\n        if (daysSinceLast > 90) groupType = 'recovered';\r\n        else groupType = 'recurrent';\r\n      }\r\n      customerHistory.set(tx.customerId, txDate);\r\n\r\n      // Chave de agrupamento: Dia/M├¬s (Daily) ou M├¬s/Ano (Monthly)\r\n      const dateKey = isDaily\r\n        ? format(txDate, 'dd/MM', { locale: ptBR })\r\n        : format(txDate, 'MMM yyyy', { locale: ptBR });\r\n\r\n      if (!historyMap.has(dateKey)) {\r\n        historyMap.set(dateKey, {\r\n          name: dateKey,\r\n          sortDate: txDate.getTime(), // Importante para ordenar corretamente jan/25 antes de fev/25\r\n          revenue: 0,\r\n          revenueInfluenced: 0,\r\n          transactions: 0,\r\n          customerSet: new Set(),\r\n          groupNew: 0,\r\n          groupRecurrent: 0,\r\n          groupRecovered: 0,\r\n        });\r\n      }\r\n      const hist = historyMap.get(dateKey);\r\n      hist.revenue += val;\r\n      hist.transactions += 1;\r\n      if (isInfluenced) hist.revenueInfluenced += val;\r\n      hist.customerSet.add(tx.customerId);\r\n\r\n      if (groupType === 'new') hist.groupNew++;\r\n      else if (groupType === 'recurrent') hist.groupRecurrent++;\r\n      else hist.groupRecovered++;\r\n\r\n      if (!storesMap.has(storeId)) {\r\n        storesMap.set(storeId, {\r\n          id: storeId,\r\n          name: tx.store.name,\r\n          code: tx.store.cnpj ? tx.store.cnpj.slice(0, 4) : 'LOJA',\r\n          revenue: 0,\r\n          revenueInfluenced: 0,\r\n          transactions: 0,\r\n          recurrentCount: 0,\r\n        });\r\n      }\r\n      const st = storesMap.get(storeId);\r\n      st.revenue += val;\r\n      st.transactions += 1;\r\n      if (isInfluenced) st.revenueInfluenced += val;\r\n      if (groupType === 'recurrent') st.recurrentCount += 1;\r\n\r\n      if (!channelsMap.has(channel))\r\n        channelsMap.set(channel, { name: channel, value: 0 });\r\n      channelsMap.get(channel).value += val;\r\n    }\r\n\r\n    const channels = Array.from(channelsMap.values())\r\n      .map((ch: any) => ({\r\n        ...ch,\r\n        percent:\r\n          totalRevenue > 0\r\n            ? ((ch.value / totalRevenue) * 100).toFixed(2)\r\n            : '0.00',\r\n      }))\r\n      .sort((a, b) => b.value - a.value);\r\n\r\n    const stores = Array.from(storesMap.values())\r\n      .map((s: any) => {\r\n        const ticket = s.transactions > 0 ? s.revenue / s.transactions : 0;\r\n        return {\r\n          ...s,\r\n          ticket: ticket,\r\n          percentInfluenced:\r\n            s.revenue > 0\r\n              ? ((s.revenueInfluenced / s.revenue) * 100).toFixed(2)\r\n              : '0.00',\r\n          repurchase:\r\n            s.transactions > 0\r\n              ? ((s.recurrentCount / s.transactions) * 100).toFixed(1)\r\n              : '0.0',\r\n          itemsPerTicket: ticket > 0 ? (ticket / 150).toFixed(2) : '0.00',\r\n        };\r\n      })\r\n      .sort((a, b) => b.revenue - a.revenue);\r\n\r\n    const history = Array.from(historyMap.values())\r\n      .sort((a: any, b: any) => a.sortDate - b.sortDate)\r\n      .map((h: any) => {\r\n        const uniqueConsumers = h.customerSet.size;\r\n        const ticket = h.transactions > 0 ? h.revenue / h.transactions : 0;\r\n        return {\r\n          ...h,\r\n          revenueOrganic: h.revenue - h.revenueInfluenced,\r\n          ticket: Math.round(ticket),\r\n          itemsPerTicket: ticket > 0 ? Number((ticket / 150).toFixed(1)) : 0,\r\n          repurchase:\r\n            h.transactions > 0\r\n              ? Number(((h.groupRecurrent / h.transactions) * 100).toFixed(1))\r\n              : 0,\r\n          revenueLastYear: h.revenue * 0.85,\r\n          consumers: uniqueConsumers,\r\n          consumersActive: Math.floor(uniqueConsumers * 0.9),\r\n          avgSpend:\r\n            uniqueConsumers > 0 ? Math.round(h.revenue / uniqueConsumers) : 0,\r\n          frequency:\r\n            uniqueConsumers > 0\r\n              ? Number((h.transactions / uniqueConsumers).toFixed(2))\r\n              : 0,\r\n          interval:\r\n            uniqueConsumers > 0\r\n              ? Math.round(30 / (h.transactions / uniqueConsumers))\r\n              : 0,\r\n          revenueNew:\r\n            Math.round((h.groupNew / h.transactions) * h.revenue) || 0,\r\n          revenueRecurrent:\r\n            Math.round((h.groupRecurrent / h.transactions) * h.revenue) || 0,\r\n          revenueRecovered:\r\n            Math.round((h.groupRecovered / h.transactions) * h.revenue) || 0,\r\n        };\r\n      });\r\n\r\n    // Capitalize names (ex: \"jan 2025\" -> \"Jan 2025\")\r\n    const formattedHistory = history.map((h) => ({\r\n      ...h,\r\n      name: h.name.charAt(0).toUpperCase() + h.name.slice(1),\r\n    }));\r\n\r\n    return {\r\n      kpis: {\r\n        revenue: totalRevenue,\r\n        revenueLastYear: totalRevenue * 0.9,\r\n        transactions: totalTransactions,\r\n        ticketAverage:\r\n          totalTransactions > 0 ? totalRevenue / totalTransactions : 0,\r\n        repurchaseRate:\r\n          totalTransactions > 0\r\n            ? (\r\n                ((totalTransactions - customerHistory.size) /\r\n                  totalTransactions) *\r\n                100\r\n              ).toFixed(2)\r\n            : 0,\r\n      },\r\n      history: formattedHistory,\r\n      channels,\r\n      stores,\r\n    };\r\n  }\r\n\r\n  // --- 5. M├ëTRICAS DE AGENDA ---\r\n  /**\r\n   * Calculates Schedule/Campaign Metrics.\r\n   * Analyzes conversion rates, revenue influenced, and contact efficiency.\r\n   */\r\n  async getScheduleMetrics(startDate: string, endDate: string, filters?: any) {\r\n    const start = new Date(`${startDate}T00:00:00`);\r\n    const end = new Date(`${endDate}T23:59:59.999`);\r\n\r\n    const campaignWhere: Prisma.CampaignWhereInput = {\r\n      date: { gte: start, lte: end },\r\n    };\r\n    const transactionWhere: Prisma.TransactionWhereInput = {\r\n      date: { gte: start, lte: end },\r\n      isInfluenced: true,\r\n      status: 'PAID',\r\n    };\r\n\r\n    if (filters?.channel && filters.channel !== 'Todos') {\r\n      const map: any = { 'Mobile push': 'Push', 'E-mail': 'Email' };\r\n      const val = map[filters.channel] || filters.channel;\r\n      campaignWhere.channel = val;\r\n      transactionWhere.channel = val;\r\n    }\r\n    if (filters?.campaignIds?.length)\r\n      campaignWhere.id = { in: filters.campaignIds };\r\n    if (filters?.tags?.length) campaignWhere.tags = { hasSome: filters.tags };\r\n    if (filters?.campaignType?.length)\r\n      campaignWhere.type = { in: filters.campaignType };\r\n    if (filters?.storeIds?.length) {\r\n      campaignWhere.storeId = { in: filters.storeIds };\r\n      transactionWhere.storeId = { in: filters.storeIds };\r\n    }\r\n\r\n    const campaigns = await this.prisma.campaign.findMany({\r\n      where: campaignWhere,\r\n      orderBy: { date: 'desc' },\r\n      include: { store: { select: { id: true, name: true } } },\r\n    });\r\n    const sales = await this.prisma.transaction.findMany({\r\n      where: transactionWhere,\r\n      select: {\r\n        totalValue: true,\r\n        date: true,\r\n        storeId: true,\r\n        salespersonId: true,\r\n      },\r\n    });\r\n\r\n    let totalDisponibilizados = 0,\r\n      totalRealizados = 0,\r\n      totalConfirmados = 0,\r\n      totalDescadastros = 0;\r\n    campaigns.forEach((c) => {\r\n      totalDisponibilizados += c.sent || 0;\r\n      totalRealizados += c.delivered || 0;\r\n      totalConfirmados += c.clicks || 0;\r\n      totalDescadastros += c.unsubscribes || 0;\r\n    });\r\n    const receitaInfluenciada = sales.reduce(\r\n      (acc, s) => acc + Number(s.totalValue),\r\n      0,\r\n    );\r\n    const conversoes = sales.length;\r\n    const naoConfirmados = totalRealizados - totalConfirmados;\r\n\r\n    const daysMap = new Map();\r\n    for (\r\n      let d = new Date(`${startDate}T12:00:00`);\r\n      d <= new Date(`${endDate}T12:00:00`);\r\n      d.setDate(d.getDate() + 1)\r\n    ) {\r\n      const key = format(d, 'dd/MM', { locale: ptBR });\r\n      daysMap.set(key, {\r\n        name: key,\r\n        isoDate: d.toISOString().split('T')[0],\r\n        receitaInf: 0,\r\n        vendasInf: 0,\r\n        realizados: 0,\r\n        confirmados: 0,\r\n        disponibilizados: 0,\r\n        descadastros: 0,\r\n      });\r\n    }\r\n\r\n    campaigns.forEach((c) => {\r\n      const key = format(c.date, 'dd/MM', { locale: ptBR });\r\n      if (daysMap.has(key)) {\r\n        const d = daysMap.get(key);\r\n        d.realizados += c.delivered;\r\n        d.confirmados += c.clicks;\r\n        d.descadastros += c.unsubscribes;\r\n        d.disponibilizados += c.sent;\r\n      }\r\n    });\r\n\r\n    sales.forEach((s) => {\r\n      const key = format(s.date, 'dd/MM', { locale: ptBR });\r\n      if (daysMap.has(key)) {\r\n        const d = daysMap.get(key);\r\n        d.receitaInf += Number(s.totalValue);\r\n        d.vendasInf += 1;\r\n      }\r\n    });\r\n\r\n    const safeDiv = (a: number, b: number) => (b > 0 ? a / b : 0);\r\n\r\n    const dailyData = Array.from(daysMap.values()).map((d: any) => ({\r\n      ...d,\r\n      receita: d.receitaInf,\r\n      conversoes: safeDiv(d.vendasInf, d.realizados),\r\n      receitaCont: safeDiv(d.receitaInf, d.realizados),\r\n      vendasCont: safeDiv(d.vendasInf, d.realizados),\r\n      naoConf: d.realizados - d.confirmados,\r\n    }));\r\n\r\n    const campaignsTable = campaigns.map((c) => {\r\n      const share = safeDiv(c.clicks, totalConfirmados);\r\n      const recInf = share * receitaInfluenciada;\r\n      const vendInf = Math.floor(share * conversoes);\r\n      return {\r\n        id: c.id,\r\n        name: c.name,\r\n        date: c.date,\r\n        channel: c.channel,\r\n        receitaInf: recInf,\r\n        receitaCont: safeDiv(recInf, c.delivered),\r\n        vendasInf: vendInf,\r\n        vendasCont: safeDiv(vendInf, c.delivered),\r\n        conversoes: safeDiv(vendInf, c.delivered),\r\n        disponibilizados: c.sent,\r\n        realizados: c.delivered,\r\n        confirmados: c.clicks,\r\n        naoConf: c.delivered - c.clicks,\r\n      };\r\n    });\r\n\r\n    const storesMap = new Map();\r\n    campaigns.forEach((c) => {\r\n      if (!storesMap.has(c.storeId))\r\n        storesMap.set(c.storeId, {\r\n          id: c.storeId,\r\n          name: c.store?.name || 'Loja',\r\n          receitaInf: 0,\r\n          vendasInf: 0,\r\n          realizados: 0,\r\n          confirmados: 0,\r\n          disponibilizados: 0,\r\n        });\r\n      const st = storesMap.get(c.storeId);\r\n      st.disponibilizados += c.sent;\r\n      st.realizados += c.delivered;\r\n      st.confirmados += c.clicks;\r\n    });\r\n    sales.forEach((s) => {\r\n      if (storesMap.has(s.storeId)) {\r\n        const st = storesMap.get(s.storeId);\r\n        st.receitaInf += Number(s.totalValue);\r\n        st.vendasInf += 1;\r\n      }\r\n    });\r\n    const storesTable = Array.from(storesMap.values()).map((s: any) => ({\r\n      ...s,\r\n      receitaCont: safeDiv(s.receitaInf, s.realizados),\r\n      vendasCont: safeDiv(s.vendasInf, s.realizados),\r\n      conversoes: safeDiv(s.vendasInf, s.realizados),\r\n      naoConf: s.realizados - s.confirmados,\r\n    }));\r\n\r\n    const sellersMap = new Map();\r\n    sales.forEach((s) => {\r\n      const sellerId = s.salespersonId || 'N/A';\r\n      if (!sellersMap.has(sellerId)) {\r\n        const storeName = storesMap.get(s.storeId)?.name || 'Loja';\r\n        sellersMap.set(sellerId, {\r\n          id: sellerId,\r\n          name:\r\n            sellerId === 'N/A'\r\n              ? 'Vendedor'\r\n              : `Vend. ${sellerId.substring(0, 4)}`,\r\n          storeName,\r\n          storeId: s.storeId,\r\n          receitaInf: 0,\r\n          vendasInf: 0,\r\n          disponibilizados: 0,\r\n          realizados: 0,\r\n          confirmados: 0,\r\n        });\r\n      }\r\n      const seller = sellersMap.get(sellerId);\r\n      seller.receitaInf += Number(s.totalValue);\r\n      seller.vendasInf += 1;\r\n    });\r\n    const sellersTable = Array.from(sellersMap.values()).map((s: any) => {\r\n      const storeStats = storesMap.get(s.storeId);\r\n      if (storeStats) {\r\n        const share = 0.2;\r\n        s.disponibilizados = Math.floor(storeStats.disponibilizados * share);\r\n        s.realizados = Math.floor(storeStats.realizados * share);\r\n        s.confirmados = Math.floor(storeStats.confirmados * share);\r\n      }\r\n      return {\r\n        ...s,\r\n        receitaCont: safeDiv(s.receitaInf, s.realizados),\r\n        vendasCont: safeDiv(s.vendasInf, s.realizados),\r\n        conversoes: safeDiv(s.vendasInf, s.realizados),\r\n        naoConf: s.realizados - s.confirmados,\r\n      };\r\n    });\r\n\r\n    return {\r\n      kpis: {\r\n        receitaInfluenciada,\r\n        contatosRealizados: totalRealizados,\r\n        contatosConfirmados: totalConfirmados,\r\n        conversoes: conversoes,\r\n        descadastros: totalDescadastros,\r\n        disponibilizados: totalDisponibilizados,\r\n        naoConfirmados: naoConfirmados,\r\n        clientesUnicos: Math.floor(totalRealizados * 0.95),\r\n        frequencia: safeDiv(totalRealizados, totalDisponibilizados).toFixed(1),\r\n      },\r\n      history: dailyData,\r\n      tables: {\r\n        campaigns: campaignsTable,\r\n        stores: storesTable,\r\n        sellers: sellersTable,\r\n        daily: dailyData,\r\n      },\r\n    };\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\danie\\OneDrive\\Documentos\\CRM-PROJETO\\backend\\src\\modules\\erp\\sync\\sync.controller.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\danie\\OneDrive\\Documentos\\CRM-PROJETO\\backend\\src\\modules\\erp\\sync\\sync.service.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'CronExpression' is defined but never used.","line":2,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":30},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'startDate' is assigned a value but never used.","line":23,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":23,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'endDate' is assigned a value but never used.","line":24,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":24,"endColumn":18},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .startId on an `any` value.","line":53,"column":22,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":53,"endColumn":29},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .endId on an `any` value.","line":53,"column":46,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":53,"endColumn":51},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .startId on an `any` value.","line":54,"column":44,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":54,"endColumn":51},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .endId on an `any` value.","line":55,"column":39,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":55,"endColumn":44},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'e' is defined but never used.","line":68,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":68,"endColumn":19},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .pedidov on an `any` value.","line":91,"column":42,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":91,"endColumn":49},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .message on an `any` value.","line":91,"column":60,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":91,"endColumn":67},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":107,"column":11,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":107,"endColumn":44},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .cliente_id_safe on an `any` value.","line":107,"column":29,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":107,"endColumn":44},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":108,"column":9,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":108,"endColumn":47},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .dados_cliente on an `any` value.","line":108,"column":29,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":108,"endColumn":42},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":113,"column":13,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":114,"endColumn":60},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string | number`.","line":114,"column":49,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":114,"endColumn":59},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":116,"column":9,"nodeType":"AssignmentExpression","messageId":"anyAssignment","endLine":116,"endColumn":39},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":128,"column":11,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":128,"endColumn":39},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .e_mail on an `any` value.","line":128,"column":33,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":128,"endColumn":39},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .pedidov on an `any` value.","line":131,"column":31,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":131,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":139,"column":16,"nodeType":"Property","messageId":"anyAssignment","endLine":139,"endColumn":28},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":141,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":141,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .nome on an `any` value.","line":141,"column":28,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":141,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":142,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":142,"endColumn":53},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .cel on an `any` value.","line":142,"column":29,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":142,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .fone on an `any` value.","line":142,"column":49,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":142,"endColumn":53},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":143,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":143,"endColumn":50},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .enderecos on an `any` value.","line":143,"column":28,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":143,"endColumn":37},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":144,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":144,"endColumn":51},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .enderecos on an `any` value.","line":144,"column":29,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":144,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":146,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":146,"endColumn":58},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .enderecos on an `any` value.","line":146,"column":36,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":146,"endColumn":45},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":147,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":147,"endColumn":50},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .enderecos on an `any` value.","line":147,"column":31,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":147,"endColumn":40},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .enderecos on an `any` value.","line":148,"column":31,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":148,"endColumn":40},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .enderecos on an `any` value.","line":149,"column":29,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":149,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .enderecos on an `any` value.","line":149,"column":70,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":149,"endColumn":79},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":151,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":151,"endColumn":53},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .tipo_pessoa on an `any` value.","line":151,"column":34,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":151,"endColumn":45},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .id_conta on an `any` value.","line":153,"column":24,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":153,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .cod_cliente on an `any` value.","line":153,"column":49,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":153,"endColumn":60},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":158,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":158,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .nome on an `any` value.","line":158,"column":28,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":158,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":159,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":159,"endColumn":21},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":160,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":160,"endColumn":53},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .cel on an `any` value.","line":160,"column":29,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":160,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .fone on an `any` value.","line":160,"column":49,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":160,"endColumn":53},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":161,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":161,"endColumn":50},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .enderecos on an `any` value.","line":161,"column":28,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":161,"endColumn":37},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":162,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":162,"endColumn":51},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .enderecos on an `any` value.","line":162,"column":29,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":162,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":164,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":164,"endColumn":58},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .enderecos on an `any` value.","line":164,"column":36,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":164,"endColumn":45},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":165,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":165,"endColumn":50},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .enderecos on an `any` value.","line":165,"column":31,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":165,"endColumn":40},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .enderecos on an `any` value.","line":166,"column":31,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":166,"endColumn":40},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .enderecos on an `any` value.","line":167,"column":29,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":167,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .enderecos on an `any` value.","line":167,"column":70,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":167,"endColumn":79},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":169,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":169,"endColumn":53},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .tipo_pessoa on an `any` value.","line":169,"column":34,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":169,"endColumn":45},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .id_conta on an `any` value.","line":171,"column":24,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":171,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .cod_cliente on an `any` value.","line":171,"column":49,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":171,"endColumn":60},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .produtos on an `any` value.","line":180,"column":28,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":180,"endColumn":36},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .produtos on an `any` value.","line":181,"column":31,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":181,"endColumn":39},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":182,"column":15,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":182,"endColumn":36},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .produto on an `any` value.","line":182,"column":29,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":182,"endColumn":36},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `number`.","line":186,"column":37,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":186,"endColumn":43},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `number`.","line":187,"column":46,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":187,"endColumn":52},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":190,"column":19,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":191,"endColumn":68},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string | number`.","line":191,"column":61,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":191,"endColumn":67},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":194,"column":21,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":197,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .nome_produto_site on an `any` value.","line":195,"column":29,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":195,"endColumn":46},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .descricao1 on an `any` value.","line":196,"column":29,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":196,"endColumn":39},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .descricao on an `any` value.","line":197,"column":29,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":197,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":199,"column":17,"nodeType":"AssignmentExpression","messageId":"anyAssignment","endLine":199,"endColumn":40},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `number`.","line":200,"column":39,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":200,"endColumn":45},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .aprovado on an `any` value.","line":218,"column":25,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":218,"endColumn":33},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":228,"column":11,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":228,"endColumn":56},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .data_emissao_parsed on an `any` value.","line":228,"column":23,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":228,"endColumn":42},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":2,"message":"Unsafe call of a(n) `any` typed value.","line":232,"column":9,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":232,"endColumn":25},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .getFullYear on an `any` value.","line":232,"column":14,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":232,"endColumn":25},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":2,"message":"Unsafe call of a(n) `any` typed value.","line":235,"column":9,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":235,"endColumn":22},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .getMonth on an `any` value.","line":235,"column":14,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":235,"endColumn":22},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":2,"message":"Unsafe call of a(n) `any` typed value.","line":236,"column":7,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":236,"endColumn":23},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .setFullYear on an `any` value.","line":236,"column":12,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":236,"endColumn":23},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":242,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":242,"endColumn":31},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .total on an `any` value.","line":242,"column":26,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":242,"endColumn":31},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":243,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":243,"endColumn":19},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":252,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":252,"endColumn":21},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":253,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":253,"endColumn":33},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .total on an `any` value.","line":253,"column":28,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":253,"endColumn":33},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":256,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":256,"endColumn":47},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .nome_vendedor on an `any` value.","line":256,"column":25,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":256,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":2,"message":"Unsafe call of a(n) `any` typed value.","line":260,"column":56,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":260,"endColumn":72},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .toISOString on an `any` value.","line":260,"column":61,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":260,"endColumn":72},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .pedidov on an `any` value.","line":265,"column":75,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":265,"endColumn":82}],"suppressedMessages":[],"errorCount":91,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Injectable, Logger } from '@nestjs/common';\r\nimport { Cron, CronExpression } from '@nestjs/schedule'; // IMPORTANTE\r\nimport { MilleniumService } from '../millenium/millenium.service';\r\nimport { PrismaService } from 'src/prisma/prisma.service';\r\nimport { subDays, startOfDay, endOfDay } from 'date-fns'; // IMPORTANTE\r\n\r\n@Injectable()\r\nexport class SyncService {\r\n  private readonly logger = new Logger(SyncService.name);\r\n  // Simple in-memory cache for product names to avoid spamming the API\r\n  private productCache = new Map<number, string>();\r\n\r\n  constructor(\r\n    private readonly milleniumService: MilleniumService,\r\n    private readonly prisma: PrismaService,\r\n  ) {}\r\n\r\n  @Cron('0 3 * * *') // 3 AM every day\r\n  async handleNightlySync() {\r\n    this.logger.log('Running nightly sales sync...');\r\n    // Sync Yesterday's data\r\n    const yesterday = subDays(new Date(), 1);\r\n    const startDate = startOfDay(yesterday);\r\n    const endDate = endOfDay(yesterday);\r\n\r\n    // Convert to whatever format ERP expects or pass Dates if MilleniumService handles it.\r\n    // MilleniumService.getSales accepts params object.\r\n    // Note: Analysis didn't specify EXACT date param names supported by ERP (data_emissao?),\r\n    // but usually it's passed as OData filter or specific params.\r\n    // Assuming we might need to filter manually or pass generic params.\r\n    // For now, let's assume we fetch by a date range param if known, or fetch recent and filter.\r\n    // Given the endpoint is /pedido_venda/consulta, likely accepts params like 'data_inicial' etc?\r\n    // User sample URL was `?pedidov=52`.\r\n    // Without doc, tricky. BUT user asked to \"get segmented\".\r\n    // I will pass these simply as params for now, assuming MilleniumService or the ERP handles them.\r\n    // IF NOT, we might need value based $filter=data_emissao gt ...\r\n    // Example: $filter=data_emissao ge datetime'...'\r\n    // I'll construct a basic OData filter.\r\n\r\n    // ASP.NET dates are tricky in filters.\r\n    // Safer bet: Pass custom params and log it.\r\n    await this.syncSales({\r\n      // Example hypothetical params.\r\n      // If ERP is OData v3/v4 standard:\r\n      // $filter: `data_emissao ge datetime'${startDate.toISOString()}'`\r\n    });\r\n  }\r\n\r\n  async syncSales(customParams: any = {}) {\r\n    this.logger.log('Starting Sales Sync...');\r\n\r\n    // Strategy: ID Range Sync (Fallback if list/date filtering fails)\r\n    if (customParams.startId && customParams.endId) {\r\n      const startStr = Number(customParams.startId);\r\n      const end = Number(customParams.endId);\r\n      let processed = 0;\r\n\r\n      this.logger.log(`Syncing by ID Range: ${startStr} to ${end}`);\r\n\r\n      for (let id = startStr; id <= end; id++) {\r\n        try {\r\n          // Fetch specific ID\r\n          const sales = await this.milleniumService.getSales({ pedidov: id });\r\n          if (sales && sales.length > 0) {\r\n            await this.processSale(sales[0]);\r\n            processed++;\r\n          }\r\n        } catch (e) {\r\n          // Ignore 404/Empty for specific ID\r\n        }\r\n      }\r\n      return { status: 'success', processed, strategy: 'id_range' };\r\n    }\r\n\r\n    // Standard Sync\r\n    // ...\r\n    const sales = await this.milleniumService.getSales(customParams);\r\n\r\n    this.logger.log(`Fetched ${sales.length} sales from ERP.`);\r\n\r\n    const newTransactions = 0;\r\n    let updatedTransactions = 0;\r\n\r\n    for (const sale of sales) {\r\n      try {\r\n        await this.processSale(sale);\r\n        // Simple counter logic (real upsert result might differ)\r\n        updatedTransactions++;\r\n      } catch (error) {\r\n        this.logger.error(\r\n          `Failed to process sale ${sale.pedidov}: ${error.message}`,\r\n        );\r\n      }\r\n    }\r\n\r\n    this.logger.log(`Sync complete. Processed ${sales.length} items.`);\r\n    return {\r\n      status: 'success',\r\n      processed: sales.length,\r\n      new: newTransactions,\r\n      updated: updatedTransactions,\r\n    };\r\n  }\r\n\r\n  private async processSale(sale: any) {\r\n    // 1. Resolve Customer\r\n    const customerId = sale.cliente_id_safe; // mapped in MilleniumService\r\n    let customerData = sale.dados_cliente?.[0];\r\n\r\n    // Fallback if no customer data in payload\r\n    if (!customerData && customerId) {\r\n      this.logger.debug(`Fetching missing customer data for ID ${customerId}`);\r\n      const fetchedCustomer =\r\n        await this.milleniumService.getCustomer(customerId);\r\n      if (fetchedCustomer) {\r\n        customerData = fetchedCustomer;\r\n      }\r\n    }\r\n\r\n    // Should we skip if no customer?\r\n    // For now, we proceed only if we have minimum data.\r\n    // Mapping:\r\n    // email is key. If no email, we can't create a 'uniquely identifiable' customer easily in this specific CRM schema\r\n    // (assuming email @unique).\r\n    // Logic: If no email, maybe generate a placeholder or skip.\r\n    // Check schema requirement: `email String @unique`.\r\n\r\n    const email = customerData?.e_mail;\r\n    if (!email) {\r\n      this.logger.warn(\r\n        `Skipping sale ${sale.pedidov} - Customer ${customerId} has no email.`,\r\n      );\r\n      return;\r\n    }\r\n\r\n    // Upsert Customer\r\n    // NOTE: In a real scenario, we might want to check if phone/etc changed.\r\n    const customer = await this.prisma.customer.upsert({\r\n      where: { email: email },\r\n      update: {\r\n        name: customerData.nome,\r\n        phone: customerData.cel || customerData.fone, // simple mapping // TODO: Refine phone extraction\r\n        city: customerData.enderecos?.[0]?.cidade,\r\n        state: customerData.enderecos?.[0]?.estado,\r\n        // Extra Fields\r\n        neighborhood: customerData.enderecos?.[0]?.bairro,\r\n        zipCode: customerData.enderecos?.[0]?.cep,\r\n        address: customerData.enderecos?.[0]?.logradouro\r\n          ? `${customerData.enderecos[0].logradouro}, ${customerData.enderecos[0].numero || 'S/N'}`\r\n          : null,\r\n        personType: customerData.tipo_pessoa || 'PF', // Default to PF\r\n        externalId: String(\r\n          customerData.id_conta || customerData.cod_cliente || customerId,\r\n        ), // Try to stick with one ID\r\n      },\r\n      create: {\r\n        storeId: 'DEFAULT',\r\n        name: customerData.nome,\r\n        email: email,\r\n        phone: customerData.cel || customerData.fone,\r\n        city: customerData.enderecos?.[0]?.cidade,\r\n        state: customerData.enderecos?.[0]?.estado,\r\n        // Extra Fields\r\n        neighborhood: customerData.enderecos?.[0]?.bairro,\r\n        zipCode: customerData.enderecos?.[0]?.cep,\r\n        address: customerData.enderecos?.[0]?.logradouro\r\n          ? `${customerData.enderecos[0].logradouro}, ${customerData.enderecos[0].numero || 'S/N'}`\r\n          : null,\r\n        personType: customerData.tipo_pessoa || 'PF',\r\n        externalId: String(\r\n          customerData.id_conta || customerData.cod_cliente || customerId,\r\n        ),\r\n\r\n        isRegistrationComplete: true,\r\n      },\r\n    });\r\n\r\n    // 2. Resolve Products (Embed Names)\r\n    const enrichedItems: any[] = [];\r\n    if (Array.isArray(sale.produtos)) {\r\n      for (const item of sale.produtos) {\r\n        const prodId = item.produto;\r\n        let prodName = String(prodId); // Default to ID\r\n\r\n        if (prodId) {\r\n          if (this.productCache.has(prodId)) {\r\n            prodName = this.productCache.get(prodId)!;\r\n          } else {\r\n            // Fetch from Vitrine\r\n            const prodDetails =\r\n              await this.milleniumService.getProductDetails(prodId);\r\n            if (prodDetails) {\r\n              // Priority: nome_produto_site > descricao1 > descricao\r\n              const nameReceived =\r\n                prodDetails.nome_produto_site ||\r\n                prodDetails.descricao1 ||\r\n                prodDetails.descricao;\r\n              if (nameReceived) {\r\n                prodName = nameReceived;\r\n                this.productCache.set(prodId, prodName);\r\n              }\r\n            }\r\n          }\r\n        }\r\n\r\n        enrichedItems.push({\r\n          ...item,\r\n          name: prodName, // This puts the real name into the JSON\r\n        });\r\n      }\r\n    }\r\n\r\n    // 3. Save Transaction\r\n    // Map status. ERP has 'status' (int) or 'aprovado' (bool).\r\n    // Mapping:\r\n    // status 2 usually means confirmed/shipped?\r\n    // For now, if \"aprovado\": true -> PAID, else PENDING.\r\n    const status = sale.aprovado ? 'PAID' : 'PENDING';\r\n\r\n    // Check duplicate by some ID?\r\n    // We don't have a unique ID in Transaction schema besides `id` (cuid).\r\n    // We should probably check if transaction exists by `date` + `customerId` + `totalValue`\r\n    // OR add an externalId field to Transaction.\r\n    // For MVP, we presume one-way sync (create new).\r\n    // RISK: Duplicates if we run sync multiple times on same range.\r\n    // WORKAROUND: Check if we have a transaction for this customer with same date/value.\r\n\r\n    const date = sale.data_emissao_parsed || new Date(); // fallback\r\n\r\n    // HACK: Bring old ERP data to present for Dashboard visibility\r\n    // If data is older than 2024, shift to 2025/2026 based on month\r\n    if (date.getFullYear() < 2024) {\r\n      const currentYear = new Date().getFullYear(); // 2026 in sim\r\n      const targetYear =\r\n        date.getMonth() > new Date().getMonth() ? currentYear - 1 : currentYear;\r\n      date.setFullYear(targetYear);\r\n    }\r\n\r\n    const existing = await this.prisma.transaction.findFirst({\r\n      where: {\r\n        customerId: customer.id,\r\n        totalValue: sale.total,\r\n        date: date,\r\n      },\r\n    });\r\n\r\n    if (!existing) {\r\n      await this.prisma.transaction.create({\r\n        data: {\r\n          storeId: customer.storeId,\r\n          customerId: customer.id,\r\n          date: date,\r\n          totalValue: sale.total,\r\n          status: status,\r\n          items: enrichedItems, // JSON\r\n          channel: sale.nome_vendedor || 'ERP', // Attendant mapping\r\n        },\r\n      });\r\n      this.logger.debug(\r\n        `Created transaction for ${customer.email} - ${date.toISOString()}`,\r\n      );\r\n    } else {\r\n      // Option: Update status if changed?\r\n      this.logger.debug(\r\n        `Transaction already exists for ${customer.email} (Sale ID ${sale.pedidov})`,\r\n      );\r\n    }\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\danie\\OneDrive\\Documentos\\CRM-PROJETO\\backend\\src\\modules\\marketing\\campaigns\\campaigns.controller.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'UseGuards' is defined but never used.","line":7,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":12},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":28,"column":11,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":28,"endColumn":42},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .user on an `any` value.","line":28,"column":29,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":28,"endColumn":33},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":32,"column":7,"nodeType":"AssignmentExpression","messageId":"anyAssignment","endLine":32,"endColumn":46},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":52,"column":11,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":52,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .user on an `any` value.","line":52,"column":25,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":52,"endColumn":29},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":64,"column":42,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":64,"endColumn":49}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import {\r\n  Controller,\r\n  Get,\r\n  Post,\r\n  Body,\r\n  Req,\r\n  UseGuards,\r\n  BadRequestException,\r\n} from '@nestjs/common';\r\nimport { CampaignsService } from './campaigns.service';\r\nimport { CreateCampaignDto } from './dto/create-campaign.dto';\r\n\r\n// Se voc├¬ j├í tem o AuthGuard configurado (JWT), importe ele aqui:\r\n// import { JwtAuthGuard } from '../../auth/jwt-auth.guard';\r\n\r\n@Controller('campaigns')\r\n// @UseGuards(JwtAuthGuard) // <--- Descomente isso para proteger as rotas\r\nexport class CampaignsController {\r\n  constructor(private readonly campaignsService: CampaignsService) {}\r\n\r\n  /**\r\n   * Creates a new marketing campaign.\r\n   * Automatically assigns the store ID based on the logged-in user.\r\n   */\r\n  @Post()\r\n  async create(@Body() createCampaignDto: CreateCampaignDto, @Req() req: any) {\r\n    // 1. Tenta pegar o storeId do usu├írio logado (Token JWT)\r\n    const userStoreId = req.user?.storeId;\r\n\r\n    // 2. Se o usu├írio estiver logado, for├ºamos o storeId dele no DTO por seguran├ºa\r\n    if (userStoreId) {\r\n      createCampaignDto.storeId = userStoreId;\r\n    }\r\n\r\n    // 3. Valida├º├úo extra caso o storeId n├úo venha nem do Token nem do Corpo\r\n    if (!createCampaignDto.storeId) {\r\n      // Se voc├¬ estiver testando sem login, lembre-se de enviar \"storeId\" no JSON\r\n      throw new BadRequestException(\r\n        'Store ID n├úo encontrado. Fa├ºa login ou envie o storeId.',\r\n      );\r\n    }\r\n\r\n    return this.campaignsService.create(createCampaignDto);\r\n  }\r\n\r\n  /**\r\n   * Lists all campaigns for the logged-in user's store.\r\n   */\r\n  @Get()\r\n  async findAll(@Req() req: any) {\r\n    // Pega o ID da loja do usu├írio logado\r\n    const storeId = req.user?.storeId;\r\n\r\n    // Se estiver testando sem login, voc├¬ pode pegar de uma query param temporariamente:\r\n    // const storeId = req.query.storeId;\r\n\r\n    if (!storeId) {\r\n      // Retorna array vazio ou erro se n├úo souber qual loja buscar\r\n      throw new BadRequestException(\r\n        'Store ID necess├írio para buscar campanhas.',\r\n      );\r\n    }\r\n\r\n    return this.campaignsService.findAll(storeId);\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\danie\\OneDrive\\Documentos\\CRM-PROJETO\\backend\\src\\modules\\marketing\\campaigns\\campaigns.module.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\danie\\OneDrive\\Documentos\\CRM-PROJETO\\backend\\src\\modules\\marketing\\campaigns\\campaigns.service.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\danie\\OneDrive\\Documentos\\CRM-PROJETO\\backend\\src\\modules\\marketing\\campaigns\\dto\\create-campaign.dto.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\danie\\OneDrive\\Documentos\\CRM-PROJETO\\backend\\src\\prisma\\prisma.service.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\danie\\OneDrive\\Documentos\\CRM-PROJETO\\backend\\test\\app.e2e-spec.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\danie\\OneDrive\\Documentos\\CRM-PROJETO\\backend\\test\\intelligence.e2e-spec.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'prismaService' is assigned a value but never used.","line":9,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":20},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `App`.","line":44,"column":20,"nodeType":"CallExpression","messageId":"unsafeArgument","endLine":44,"endColumn":39},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `App`.","line":54,"column":20,"nodeType":"CallExpression","messageId":"unsafeArgument","endLine":54,"endColumn":39},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .metrics on an `any` value.","line":60,"column":25,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":60,"endColumn":32}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Test, TestingModule } from '@nestjs/testing';\r\nimport { INestApplication } from '@nestjs/common';\r\nimport request from 'supertest';\r\nimport { IntelligenceModule } from './../src/modules/crm/intelligence/intelligence.module';\r\nimport { PrismaService } from './../src/prisma/prisma.service';\r\n\r\ndescribe('IntelligenceController (E2E)', () => {\r\n  let app: INestApplication;\r\n  let prismaService: PrismaService;\r\n\r\n  const mockPrisma = {\r\n    segment: {\r\n      findMany: jest.fn().mockResolvedValue([]),\r\n    },\r\n    customer: {\r\n      count: jest.fn().mockResolvedValue(100),\r\n      findMany: jest.fn().mockResolvedValue([]),\r\n      aggregate: jest.fn().mockResolvedValue({\r\n        _sum: { totalSpent: 1000 },\r\n        _count: { id: 10, email: 5, phone: 3 },\r\n      }),\r\n    },\r\n  };\r\n\r\n  beforeEach(async () => {\r\n    const moduleFixture: TestingModule = await Test.createTestingModule({\r\n      imports: [IntelligenceModule],\r\n    })\r\n      .overrideProvider(PrismaService)\r\n      .useValue(mockPrisma)\r\n      .compile();\r\n\r\n    app = moduleFixture.createNestApplication();\r\n    await app.init();\r\n\r\n    prismaService = moduleFixture.get<PrismaService>(PrismaService);\r\n  });\r\n\r\n  afterAll(async () => {\r\n    await app.close();\r\n  });\r\n\r\n  it('/webhook/crm/intelligence/segments (GET)', () => {\r\n    return request(app.getHttpServer())\r\n      .get('/webhook/crm/intelligence/segments')\r\n      .expect(200)\r\n      .expect((res) => {\r\n        expect(res.body).toHaveProperty('segments');\r\n        expect(res.body).toHaveProperty('totalCustomers');\r\n      });\r\n  });\r\n\r\n  it('/webhook/crm/intelligence/preview (POST)', () => {\r\n    return request(app.getHttpServer())\r\n      .post('/webhook/crm/intelligence/preview')\r\n      .send({ rules: [] })\r\n      .expect(201)\r\n      .expect((res) => {\r\n        expect(res.body).toHaveProperty('metrics');\r\n        expect(res.body.metrics.total).toBe(100);\r\n      });\r\n  });\r\n});\r\n","usedDeprecatedRules":[]}]
