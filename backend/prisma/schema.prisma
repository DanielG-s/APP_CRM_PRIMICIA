generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- 1. ACESSO & SEGURANÇA ---
model User {
  id              String    @id @default(uuid())
  name            String?
  email           String    @unique
  password        String
  role            String
  twoFactorSecret String?
  storeId         String?
  store           Store?    @relation(fields: [storeId], references: [id])
  createdAt       DateTime  @default(now())
  segmentsUpdated Segment[] @relation("SegmentUpdater")
}

model Store {
  id              String                @id @default(uuid())
  name            String
  cnpj            String?
  cityNormalized  String?
  whatsappNumbers StoreWhatsappNumber[]
  goals           StoreGoal[]
  users           User[]
  customers       Customer[]
  transactions    Transaction[]
  campaigns       Campaign[]
  segments        Segment[]
}

// --- 2. CLIENTES ---
model Customer {
  id                     String           @id @default(uuid())
  storeId                String
  store                  Store            @relation(fields: [storeId], references: [id])
  externalId             String?
  name                   String
  email                  String?          @unique
  phone                  String?
  cpf                    String?
  birthDate              DateTime?
  age                    Int?
  city                   String?
  state                  String?
  
  // --- CAMPOS ANTIGOS ---
  rfmScoreId             String?
  rfmScore               RfmScore?        @relation(fields: [rfmScoreId], references: [id])
  propensityScore        Float?
  propensityLabel        String?
  isRegistrationComplete Boolean          @default(false)
  dataQualityIssues      Json?

  // --- CAMPOS DE PERFORMANCE (CACHE) ---
  totalSpent             Decimal          @default(0) @db.Decimal(10, 2)
  ordersCount            Int              @default(0)
  lastOrderDate          DateTime?
  rfmStatus              String?          @default("Novos / Sem Dados")

  // --- RELACIONAMENTOS ---
  events                 CustomerEvent[]
  transactions           Transaction[]
  rfmHistory             RfmHistory[]
  responses              SurveyResponse[]
  conversations          Conversation[]
}

model CustomerEvent {
  id         String   @id @default(uuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])
  eventType  String
  payload    Json?
  createdAt  DateTime @default(now())
}

model Transaction {
  id            String   @id @default(uuid())
  customerId    String
  customer      Customer @relation(fields: [customerId], references: [id])
  storeId       String
  store         Store    @relation(fields: [storeId], references: [id])
  salespersonId String?
  totalValue    Decimal
  items         Json
  date          DateTime

  // --- NOVOS CAMPOS ---
  channel       String   @default("Loja Física")
  isInfluenced  Boolean  @default(false)
}

// --- 3. SEGMENTAÇÃO ---
model Segment {
  id          String   @id @default(uuid())
  name        String
  logic       String?
  rules       Json
  isDynamic   Boolean  @default(true)
  storeId     String
  store       Store    @relation(fields: [storeId], references: [id])
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt
  
  // Cache de tamanho (para a listagem rápida) - NOVO
  lastCount   Int      @default(0)

  // Quem alterou pela última vez?
  updatedById String?
  updatedBy   User?    @relation("SegmentUpdater", fields: [updatedById], references: [id])

  // Histórico de evolução - NOVO
  history     SegmentHistory[]
}

// TABELA NOVA: Histórico Diário de Segmentos
model SegmentHistory {
  id        String   @id @default(uuid())
  segmentId String
  segment   Segment  @relation(fields: [segmentId], references: [id], onDelete: Cascade)
  
  count     Int      // Tamanho do público neste dia
  date      DateTime @default(now()) // Data do registro

  @@index([segmentId, date])
}

// --- 4. CAMPANHAS ---
model Campaign {
  id                String             @id @default(uuid())
  storeId           String
  store             Store              @relation(fields: [storeId], references: [id])
  name              String
  channel           String 
  status            String             @default("draft") 
  date              DateTime 
  type              String?  
  tags              String[] 
  
  segmentId         String? 
  audienceSize      Int?               @default(0)

  config            Json? 
  content           Json? 

  scheduledAt       DateTime?

  sent              Int                @default(0)
  delivered         Int                @default(0)
  opens             Int                @default(0)
  clicks            Int                @default(0)
  softBounces       Int                @default(0)
  hardBounces       Int                @default(0)
  spamReports       Int                @default(0)
  unsubscribes      Int                @default(0)

  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  metrics           CampaignMetric?
  schedules         CampaignSchedule[]
  contents          CampaignContent[]

  attributionWindow Int?               @default(7)
  conversionTrigger String?
}

model CampaignSchedule {
  id         String   @id @default(uuid())
  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id])
  sendDate   DateTime
}

model CampaignContent {
  id         String   @id @default(uuid())
  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id])
  subject    String?
  body       String
  mediaUrl   String?
}

model CampaignMetric {
  id                String   @id @default(uuid())
  campaignId        String   @unique
  campaign          Campaign @relation(fields: [campaignId], references: [id])
  sentCount         Int      @default(0)
  revenueInfluenced Decimal  @default(0.0)
  repurchaseRate    Float    @default(0.0)
}

// --- 5. RFM ---
model RfmScore {
  id         String     @id @default(uuid())
  name       String
  minRecency Int
  maxRecency Int
  customers  Customer[]
}

model RfmHistory {
  id         String   @id @default(uuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])
  oldScoreId String?
  newScoreId String
  changedAt  DateTime @default(now())
}

// --- 6. WHATSAPP ---
model StoreWhatsappNumber {
  id           String @id @default(uuid())
  storeId      String
  store        Store  @relation(fields: [storeId], references: [id])
  number       String
  provider     String
  routingRules Json?
}

model Conversation {
  id         String   @id @default(uuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])
  storeId    String
  status     String
  messages   Json
}

// --- 7. PESQUISAS ---
model SurveyResponse {
  id            String   @id @default(uuid())
  customerId    String
  customer      Customer @relation(fields: [customerId], references: [id])
  salespersonId String?
  score         Int
  comment       String?
  channel       String
  createdAt     DateTime @default(now())
}

// --- 8. METAS ---
model StoreGoal {
  id            String @id @default(uuid())
  storeId       String
  store         Store  @relation(fields: [storeId], references: [id])
  month         Int
  year          Int
  whatsappLimit Int
  emailLimit    Int
}