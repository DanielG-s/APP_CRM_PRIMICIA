generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Campaign {
  id                String             @id @default(cuid())
  storeId           String
  name              String
  channel           String
  status            String             @default("draft")
  date              DateTime           @default(now())
  type              String?
  tags              String[]
  segmentId         String?
  audienceSize      Int?               @default(0)
  config            Json?
  content           Json?
  scheduledAt       DateTime?
  sent              Int                @default(0)
  delivered         Int                @default(0)
  opens             Int                @default(0)
  clicks            Int                @default(0)
  softBounces       Int                @default(0)
  hardBounces       Int                @default(0)
  spamReports       Int                @default(0)
  unsubscribes      Int                @default(0)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  attributionWindow Int?               @default(7)
  conversionTrigger String?
  store             Store              @relation(fields: [storeId], references: [id])
  contents          CampaignContent[]
  metrics           CampaignMetric?
  schedules         CampaignSchedule[]
}

model CampaignContent {
  id         String   @id @default(cuid())
  campaignId String
  subject    String?
  body       String
  mediaUrl   String?
  designJson Json?
  campaign   Campaign @relation(fields: [campaignId], references: [id])
}

model CampaignMetric {
  id                String   @id @default(cuid())
  campaignId        String   @unique
  sentCount         Int      @default(0)
  revenueInfluenced Decimal  @default(0.0)
  repurchaseRate    Float    @default(0.0)
  campaign          Campaign @relation(fields: [campaignId], references: [id])
}

model CampaignSchedule {
  id         String   @id @default(cuid())
  campaignId String
  sendDate   DateTime
  campaign   Campaign @relation(fields: [campaignId], references: [id])
}

model Conversation {
  id         String   @id @default(cuid())
  customerId String
  storeId    String
  status     String
  messages   Json
  customer   Customer @relation(fields: [customerId], references: [id])
}

model Customer {
  id                     String    @id @default(cuid())
  storeId                String
  externalId             String?
  name                   String
  email                  String?
  phone                  String?
  cpf                    String?
  birthDate              DateTime?
  age                    Int?
  city                   String?
  rfmScoreId             String?
  propensityScore        Float?
  propensityLabel        String?
  isRegistrationComplete Boolean   @default(false)
  dataQualityIssues      Json?
  totalSpent             Decimal   @default(0) @db.Decimal(10, 2)
  state                  String?
  lastOrderDate          DateTime?
  ordersCount            Int       @default(0)
  rfmStatus              String?   @default("Novos / Sem Dados")
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @default(now()) @updatedAt

  // Fields for Extra Characteristics (ERP)
  neighborhood String?
  zipCode      String?
  address      String?
  personType   String?

  conversations   Conversation[]
  rfmScore        RfmScore?        @relation(fields: [rfmScoreId], references: [id])
  store           Store            @relation(fields: [storeId], references: [id])
  customerEvents  CustomerEvent[]
  rfmHistory      RfmHistory[]
  surveyResponses SurveyResponse[]
  transactions    Transaction[]
}

model CustomerEvent {
  id         String   @id @default(cuid())
  customerId String
  eventType  String
  payload    Json?
  createdAt  DateTime @default(now())
  customer   Customer @relation(fields: [customerId], references: [id])
}

model EmailSettings {
  id          String   @id @default(cuid())
  storeId     String   @unique
  senderName  String
  senderEmail String
  replyTo     String?
  host        String
  port        Int
  user        String
  pass        String
  secure      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  store       Store    @relation(fields: [storeId], references: [id])
}

model RfmHistory {
  id         String   @id @default(cuid())
  customerId String
  oldScoreId String?
  newScoreId String
  changedAt  DateTime @default(now())
  customer   Customer @relation(fields: [customerId], references: [id])
}

model RfmScore {
  id         String     @id @default(cuid())
  name       String
  minRecency Int
  maxRecency Int
  customers  Customer[]
}

model Segment {
  id          String           @id @default(cuid())
  name        String
  logic       String?
  rules       Json
  isDynamic   Boolean          @default(true)
  storeId     String
  active      Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @default(now()) @updatedAt
  updatedById String?
  lastCount   Int              @default(0)
  store       Store            @relation(fields: [storeId], references: [id])
  updatedBy   User?            @relation(fields: [updatedById], references: [id])
  history     SegmentHistory[]
}

model SegmentHistory {
  id        String   @id @default(cuid())
  segmentId String
  count     Int
  date      DateTime @default(now())
  segment   Segment  @relation(fields: [segmentId], references: [id], onDelete: Cascade)

  @@index([segmentId, date])
}

model Store {
  id              String                @id @default(cuid())
  name            String
  tradeName       String?
  code            String?               @unique
  cnpj            String?
  isActive        Boolean               @default(true)
  syncEnabled     Boolean               @default(true)
  cityNormalized  String?
  campaigns       Campaign[]
  customers       Customer[]
  emailSettings   EmailSettings?
  segments        Segment[]
  goals           StoreGoal[]
  whatsappNumbers StoreWhatsappNumber[]
  transactions    Transaction[]
  users           User[]
}

model StoreGoal {
  id            String @id @default(cuid())
  storeId       String
  month         Int
  year          Int
  whatsappLimit Int
  emailLimit    Int
  store         Store  @relation(fields: [storeId], references: [id])
}

model StoreWhatsappNumber {
  id           String  @id @default(cuid())
  storeId      String
  number       String
  provider     String  @default("evolution")
  instanceName String?
  isDefault    Boolean @default(false)
  name         String
  status       String  @default("DISCONNECTED")
  token        String?
  store        Store   @relation(fields: [storeId], references: [id])
}

model SurveyResponse {
  id            String   @id @default(cuid())
  customerId    String
  salespersonId String?
  score         Int
  comment       String?
  channel       String
  createdAt     DateTime @default(now())
  customer      Customer @relation(fields: [customerId], references: [id])
}

model Transaction {
  id            String   @id @default(cuid())
  externalId    String?  @unique
  customerId    String
  storeId       String
  salespersonId String?
  totalValue    Decimal
  items         Json
  date          DateTime
  channel       String   @default("Loja FÃ­sica")
  isInfluenced  Boolean  @default(false)
  status        String   @default("PAID")
  customer      Customer @relation(fields: [customerId], references: [id])
  store         Store    @relation(fields: [storeId], references: [id])
}

model User {
  id              String    @id @default(cuid())
  clerkId         String?   @unique
  email           String    @unique
  password        String?
  role            String
  twoFactorSecret String?
  storeId         String?
  createdAt       DateTime  @default(now())
  name            String?
  segments        Segment[]
  store           Store?    @relation(fields: [storeId], references: [id])
}

model Product {
  id         String   @id @default(cuid())
  storeId    String?
  externalId String   @unique
  name       String
  price      Decimal?
  category   String?
  brand      String?
  status     String?  @default("ACTIVE")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  // Future relationships can be added here
}

model JobRun {
  id           String    @id @default(cuid())
  queue        String
  jobName      String
  jobId        String
  tenantId     String?
  status       String    // "COMPLETED" | "FAILED"
  startedAt    DateTime  @default(now())
  finishedAt   DateTime?
  durationMs   Int?
  attemptsMade Int?
  error        String?
  safePayload  Json?     // Sanitized payload (no PII)
}
