import { PrismaClient } from '@prisma/client';
import { fakerPT_BR as faker } from '@faker-js/faker';

const prisma = new PrismaClient();

// Defini√ß√£o dos canais com Pesos
const SALES_CHANNELS = [
  { value: 'Loja F√≠sica', weight: 40 }, 
  { value: 'WhatsApp', weight: 30 },
  { value: 'E-commerce', weight: 20 },
  { value: 'Instagram', weight: 5 },
  { value: 'Marketplace', weight: 5 }
];

async function main() {
  console.log('üöÄ Iniciando Seed FINAL (Hist√≥rico 2024-2026)...');

  // 1. Limpeza de tabelas
  const cleanTable = async (model: any) => { try { await model.deleteMany(); } catch (e) {} };

  await cleanTable(prisma.campaignMetric);
  await cleanTable(prisma.campaignContent);
  await cleanTable(prisma.campaignSchedule);
  await cleanTable(prisma.campaign);
  await cleanTable(prisma.segmentHistory);
  await cleanTable(prisma.segment);
  await cleanTable(prisma.transaction);
  await cleanTable(prisma.storeWhatsappNumber);
  await cleanTable(prisma.emailSettings);
  await cleanTable(prisma.conversation);
  await cleanTable(prisma.customerEvent);
  await cleanTable(prisma.rfmHistory);
  await cleanTable(prisma.customer);
  await cleanTable(prisma.user);
  await cleanTable(prisma.store);

  // 2. Loja e Usu√°rio Admin
  const store = await prisma.store.create({
    data: {
      name: 'Prim√≠cia Modas - Matriz',
      cnpj: '12.345.678/0001-90',
      cityNormalized: 'sao paulo',
      users: {
        create: {
          name: 'Daniel Admin',
          email: 'admin@primicia.com',
          password: 'admin', 
          role: 'ADMIN',
        },
      },
      emailSettings: {
        create: {
          senderName: 'Equipe Prim√≠cia',
          senderEmail: 'news@primicia.com.br',
          host: 'smtp.sendgrid.net',
          port: 587,
          user: 'apikey',
          pass: 'SG.fake_key_123',
          secure: true,
        }
      },
      whatsappNumbers: {
        create: [
          {
            name: 'Comercial Loja 01',
            number: '5511999998888',
            provider: 'evolution',
            status: 'CONNECTED',
            isDefault: true,
            instanceName: 'primicia_main',
            token: 'xyz-token-123'
          }
        ]
      }
    },
  });

  console.log(`üè™ Loja criada: ${store.name}`);

  // 3. Produtos Exemplo
  const products = [
    { name: 'Camiseta B√°sica Algod√£o', price: 49.90, category: 'Roupas' },
    { name: 'Camisa Polo Premium', price: 89.90, category: 'Roupas' },
    { name: 'Cal√ßa Jeans Skinny', price: 129.90, category: 'Roupas' },
    { name: 'Vestido Floral', price: 199.90, category: 'Roupas' },
    { name: 'T√™nis Casual', price: 299.90, category: 'Cal√ßados' },
  ];

  // 4. Clientes e Transa√ß√µes (Base Hist√≥rica)
  const customersToCreate = 2500; 
  console.log(`‚è≥ Gerando ${customersToCreate} clientes e hist√≥rico de vendas desde 2024...`);

  const today = new Date();
  const startOf2024 = new Date('2024-01-01T00:00:00.000Z');
  const startOfCurrentMonth = new Date(today.getFullYear(), today.getMonth(), 1);

  for (let i = 0; i < customersToCreate; i++) {
    const hasOrders = Math.random() > 0.15; 
    
    let totalSpent = 0;
    let ordersCount = 0;
    let lastOrderDate: Date | null = null;
    let rfmStatus = 'Novos / Sem Dados';

    const firstName = faker.person.firstName();
    const lastName = faker.person.lastName();
    const uniqueEmail = `${firstName.toLowerCase()}.${lastName.toLowerCase()}.${i}@exemplo.com`;

    // Data de cadastro aleat√≥ria entre 2023 e hoje
    const createdAt = faker.date.between({ from: '2023-01-01', to: today });

    const createdCustomer = await prisma.customer.create({
      data: {
        storeId: store.id,
        name: `${firstName} ${lastName}`,
        email: uniqueEmail,
        phone: faker.phone.number({ style: 'national' }),
        city: faker.helpers.arrayElement(['S√£o Paulo', 'Rio de Janeiro', 'Curitiba', 'Belo Horizonte']),
        state: faker.helpers.arrayElement(['SP', 'RJ', 'PR', 'MG']),
        birthDate: faker.date.birthdate({ min: 18, max: 65, mode: 'age' }),
        isRegistrationComplete: true,
        createdAt: createdAt
      }
    });

    if (hasOrders) {
      const numOrders = faker.number.int({ min: 1, max: 15 }); // At√© 15 compras por cliente
      
      for (let j = 0; j < numOrders; j++) {
        // DISTRIBUI√á√ÉO DE DATA IMPORTANTE:
        // 20% das vendas caem no m√™s atual (para o dashboard inicial ser √∫til)
        // 80% das vendas caem entre Jan/2024 e Hoje (para preencher o hist√≥rico)
        let date;
        if (Math.random() < 0.2) {
             date = faker.date.between({ from: startOfCurrentMonth, to: today });
        } else {
             date = faker.date.between({ from: startOf2024, to: today });
        }

        // Se a data da compra for antes do cadastro, "ajustamos" a l√≥gica (opcional, mas bom pra consist√™ncia)
        if (date < createdAt) {
            // Ignora ou assume que comprou como convidado antes
        }

        const numItems = faker.number.int({ min: 1, max: 3 });
        const items: any[] = [];
        let orderTotal = 0;

        for (let k = 0; k < numItems; k++) {
          const prod = faker.helpers.arrayElement(products);
          items.push(prod);
          orderTotal += prod.price;
        }

        const channelName = faker.helpers.weightedArrayElement(SALES_CHANNELS);

        await prisma.transaction.create({
          data: {
            storeId: store.id,
            customerId: createdCustomer.id,
            date: date,
            totalValue: orderTotal,
            channel: channelName,
            items: items, 
            status: 'PAID',
            isInfluenced: Math.random() > 0.6
          }
        });

        totalSpent += orderTotal;
        ordersCount++;
        if (!lastOrderDate || date > lastOrderDate) lastOrderDate = date;
      }

      // C√°lculo RFM Atual
      const daysSince = lastOrderDate ? Math.floor((new Date().getTime() - lastOrderDate.getTime()) / 86400000) : 999;
      if (totalSpent > 1500 && daysSince < 30) rfmStatus = 'Champions';
      else if (totalSpent > 500 && daysSince < 60) rfmStatus = 'Leais';
      else if (daysSince < 30) rfmStatus = 'Recentes';
      else if (daysSince > 90) rfmStatus = 'Em Risco';
      else rfmStatus = 'Novos / Sem Dados';

      await prisma.customer.update({
        where: { id: createdCustomer.id },
        data: { totalSpent, ordersCount, lastOrderDate, rfmStatus }
      });
    }
    
    if((i+1) % 500 === 0) console.log(`‚úÖ ${i+1} clientes processados...`);
  }

  // 5. Segmentos e Hist√≥rico (Expandido para 90 dias)
  console.log('üìä Gerando Segmentos e Hist√≥rico (90 dias)...');
  
  const segmentsList = [
    { name: 'Champions (VIP)', baseCount: 150 },
    { name: 'Em Risco (Churn)', baseCount: 420 },
    { name: 'Novos Clientes (30d)', baseCount: 85 },
    { name: 'Leais (Recorrentes)', baseCount: 300 },
    { name: 'Engajados no WhatsApp', baseCount: 650 },
    { name: 'Ticket M√©dio Alto', baseCount: 120 }
  ];

  for (const seg of segmentsList) {
    const createdSeg = await prisma.segment.create({
      data: {
        storeId: store.id,
        name: seg.name,
        active: true,
        isDynamic: true,
        rules: [],
        lastCount: seg.baseCount
      }
    });

    // 90 dias de hist√≥rico
    for (let d = 90; d >= 0; d--) {
      const date = new Date();
      date.setDate(date.getDate() - d);
      
      const variation = Math.floor(Math.random() * 20) - 10;
      // Adiciona uma leve tend√™ncia de crescimento ao longo do tempo
      const trend = Math.floor((90 - d) * 0.5); 
      const historyCount = Math.max(0, seg.baseCount + variation + trend);

      await prisma.segmentHistory.create({
        data: {
          segmentId: createdSeg.id,
          date: date,
          count: historyCount
        }
      });
    }
  }

  // 6. Campanhas (2024, 2025 e Futuro)
  console.log('üìÖ Gerando Agenda de Campanhas (2024-2026)...');
  const campTypes = ['email', 'whatsapp'];
  
  // Campanhas Antigas (2024 e in√≠cio de 2025)
  for(let i=0; i<12; i++) {
     const pastDate = faker.date.between({ from: startOf2024, to: today });
     await prisma.campaign.create({
        data: {
            storeId: store.id,
            name: `Oferta Mensal - ${pastDate.getMonth()+1}/${pastDate.getFullYear()}`,
            channel: faker.helpers.arrayElement(campTypes),
            status: 'sent',
            type: 'promotional',
            date: pastDate,
            audienceSize: 1000 + (i*50),
            sent: 1000 + (i*50), delivered: 980 + (i*50), opens: 400 + (i*20), clicks: 100 + (i*10),
            metrics: { create: { sentCount: 1000 + (i*50), revenueInfluenced: 5000.00 + (i*100), repurchaseRate: 10 } },
            contents: { create: { body: 'Oferta Passada' } }
        }
     });
  }
  
  // Futuro
  for(let i=0; i<5; i++) {
    await prisma.campaign.create({
       data: {
           storeId: store.id,
           name: `Lan√ßamento Futuro #${i+1}`,
           channel: faker.helpers.arrayElement(campTypes),
           status: 'scheduled',
           scheduledAt: faker.date.soon({ days: 60 }),
           contents: { create: { body: 'Em breve' } }
       }
    });
 }

  console.log('‚úÖ Seed Finalizado! Login: admin@primicia.com / admin');
}

main()
  .catch((e) => { console.error(e); process.exit(1); })
  .finally(async () => { await prisma.$disconnect(); });